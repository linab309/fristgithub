###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                08/Apr/2013  11:22:08 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Com #
#                          ponents\mt\MT_TASK.c                               #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0 #
#                          \Projects\zstack\Samples\WSN_sensors\CC2530DB\..\. #
#                          .\..\Tools\CC2530DB\f8wRouter.cfg" (-DCPU32MHZ     #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DRTR_NWK -DBLINK_LEDS) -f "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\Tools\CC #
#                          2530DB\f8wConfig.cfg" (-DSECURE=0                  #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Co #
#                          mponents\mt\MT_TASK.c" -D ZTOOL_P1 -D MT_TASK -D   #
#                          MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG  #
#                          -lC "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3. #
#                          0\Projects\zstack\Samples\WSN_sensors\CC2530DB\Rou #
#                          terEB\List\" -lA "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\RouterEB\List\"   #
#                          --diag_suppress Pe001,Pa010 -o "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\RouterEB\Obj\"    #
#                          -e --require_prototypes --no_unroll --no_inline    #
#                          --no_tbaa --debug --core=plain --dptr=16,1         #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 8 -I  #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pr #
#                          ojects\zstack\Samples\WSN_sensors\CC2530DB\" -I    #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pr #
#                          ojects\zstack\Samples\WSN_sensors\CC2530DB\..\SOUR #
#                          CE\" -I "C:\Texas Instruments\ZStack-CC2530-2.2.2- #
#                          1.3.0\Projects\zstack\Samples\WSN_sensors\CC2530DB #
#                          \..\..\..\ZMAIN\TI2530DB\" -I "C:\Texas            #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MT\" -I "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\HAL\INCLUDE\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\HAL\TARGET\CC2530EB\" -I "C:\Texas        #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\OSAL\MCU\CCSOC\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\OSAL\INCLUDE\" -I "C:\Texas               #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\AF\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\NWK\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SEC\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SAPI\" -I "C:\Texas                 #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SYS\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\ZDO\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\ZMAC\F8W\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\ZMAC\" -I "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\SERVICES\SADDR\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\SERVICES\SDATA\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\INCLUDE\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\HIGH_LEVEL\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\LOW_LEVEL\srf04\" -I "C:\Texas        #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\" -I      #
#                          "D:\Program Files\IAR Systems\Embedded Workbench   #
#                          5.3\8051\INC\" -I "D:\Program Files\IAR            #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\" -Om #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pro #
#                          jects\zstack\Samples\WSN_sensors\CC2530DB\RouterEB #
#                          \List\MT_TASK.lst                                  #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pro #
#                          jects\zstack\Samples\WSN_sensors\CC2530DB\RouterEB #
#                          \Obj\MT_TASK.r51                                   #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Components\mt\MT_TASK.c
      1          /***************************************************************************************************
      2            Filename:       MT_TASK.c
      3            Revised:        $Date: 2009-03-12 16:25:22 -0700 (Thu, 12 Mar 2009) $
      4            Revision:       $Revision: 19404 $
      5          
      6            Description:    MonitorTest Task handling routines
      7          
      8            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT_TASK.h"
     45          #include "MT.h"
     46          #include "MT_DEBUG.h"
     47          #include "MT_UART.h"
     48          #include "MT_SYS.h"
     49          
     50          #include "hal_uart.h"
     51          
     52          #include "OSAL_Memory.h"
     53          
     54          /***************************************************************************************************
     55           * LOCAL FUNCTIONS
     56           ***************************************************************************************************/
     57          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg );
     58          
     59          /***************************************************************************************************
     60           * GLOBALS
     61           ***************************************************************************************************/
     62          
     63          /***************************************************************************************************
     64           * @fn      MT_TaskInit
     65           *
     66           * @brief  MonitorTest Task Initialization.  This function is put into the
     67           *         task table.
     68           *
     69           * @param   byte task_id - task ID of the MT Task
     70           *
     71           * @return  void
     72           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     73          void MT_TaskInit(uint8 task_id)
   \                     MT_TaskInit:
     74          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
     75            /* Initialize MT */
     76            MT_Init(task_id);
   \   000007                ; Setup parameters for call to function MT_Init
   \   000007   12....       LCALL   ??MT_Init?relay
     77          
     78            /* Initialize the Serial port */
     79            MT_UartInit();
   \   00000A                ; Setup parameters for call to function MT_UartInit
   \   00000A   12....       LCALL   ??MT_UartInit?relay
     80          
     81            /* Register taskID - Do this after UartInit() because it will reset the taskID */
     82            MT_UartRegisterTaskID (task_id);
   \   00000D                ; Setup parameters for call to function MT_UartRegisterTaskID
   \   00000D   EE           MOV     A,R6
   \   00000E   F9           MOV     R1,A
   \   00000F   12....       LCALL   ??MT_UartRegisterTaskID?relay
     83          
     84          } /* MT_TaskInit() */
   \   000012   7F01         MOV     R7,#0x1
   \   000014   02....       LJMP    ?BANKED_LEAVE_XDATA
     85          
     86          /***************************************************************************************************
     87           * @fn      MT_ProcessEvent
     88           *
     89           * @brief MonitorTest Task Event Processor.  This task is put into the task table.
     90           *
     91           * @param   byte task_id - task ID of the MT Task
     92           * @param   UINT16 events - event(s) for the MT Task
     93           *
     94           * @return  void
     95           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     96          UINT16 MT_ProcessEvent(uint8 task_id, uint16 events)
   \                     MT_ProcessEvent:
     97          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
     98            uint8 *msg_ptr;
     99            
    100            (void)task_id;  // Intentionally unreferenced parameter
    101          
    102            /* Could be multiple events, so switch won't work */
    103            if ( events & SYS_EVENT_MSG )
   \   000009   7480         MOV     A,#-0x80
   \   00000B   5F           ANL     A,R7
   \   00000C   F9           MOV     R1,A
   \   00000D   E4           CLR     A
   \   00000E   7001         JNZ     ??MT_ProcessEvent_0
   \   000010   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_0:
   \   000011   700E         JNZ     ??MT_ProcessEvent_1
    104            {
    105              while ( (msg_ptr = osal_msg_receive( MT_TaskID )) )
    106              {
    107                MT_ProcessIncomingCommand((mtOSALSerialData_t *)msg_ptr);
    108              }
    109          
    110              /* Return unproccessed events */
    111              return (events ^ SYS_EVENT_MSG);
    112            }
    113          
    114            if ( events & MT_ZTOOL_SERIAL_RCV_BUFFER_FULL )
   \   000013   EE           MOV     A,R6
   \   000014   5404         ANL     A,#0x4
   \   000016   601F         JZ      ??MT_ProcessEvent_2
    115            {
    116              /* Return unproccessed events */
    117              return (events ^ MT_ZTOOL_SERIAL_RCV_BUFFER_FULL);
   \   000018   7404         MOV     A,#0x4
   \   00001A   6E           XRL     A,R6
   \   00001B   FA           MOV     R2,A
   \   00001C   8078         SJMP    ??MT_ProcessEvent_3
    118            }
   \                     ??MT_ProcessEvent_4:
   \   00001E                ; Setup parameters for call to function MT_ProcessIncomingCommand
   \   00001E   12....       LCALL   ??MT_ProcessIncomingCommand?relay
   \                     ??MT_ProcessEvent_1:
   \   000021                ; Setup parameters for call to function osal_msg_receive
   \   000021   90....       MOV     DPTR,#MT_TaskID
   \   000024   E0           MOVX    A,@DPTR
   \   000025   F9           MOV     R1,A
   \   000026   12....       LCALL   ??osal_msg_receive?relay
   \   000029   EA           MOV     A,R2
   \   00002A   7001         JNZ     ??MT_ProcessEvent_5
   \   00002C   EB           MOV     A,R3
   \                     ??MT_ProcessEvent_5:
   \   00002D   70EF         JNZ     ??MT_ProcessEvent_4
   \   00002F   EE           MOV     A,R6
   \   000030   FA           MOV     R2,A
   \   000031   7480         MOV     A,#-0x80
   \   000033   6F           XRL     A,R7
   \                     ??MT_ProcessEvent_6:
   \   000034   FB           MOV     R3,A
   \   000035   805F         SJMP    ??MT_ProcessEvent_3
    119          
    120            /* Handle MT_SYS_OSAL_START_TIMER callbacks */
    121          #if defined MT_SYS_FUNC
    122            if ( events & (MT_SYS_OSAL_EVENT_MASK))
   \                     ??MT_ProcessEvent_2:
   \   000037   740F         MOV     A,#0xf
   \   000039   5F           ANL     A,R7
   \   00003A   F9           MOV     R1,A
   \   00003B   E4           CLR     A
   \   00003C   7001         JNZ     ??MT_ProcessEvent_7
   \   00003E   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_7:
   \   00003F   6051         JZ      ??MT_ProcessEvent_8
    123            {
    124              if (events & MT_SYS_OSAL_EVENT_0)
   \   000041   7408         MOV     A,#0x8
   \   000043   5F           ANL     A,R7
   \   000044   F9           MOV     R1,A
   \   000045   E4           CLR     A
   \   000046   7001         JNZ     ??MT_ProcessEvent_9
   \   000048   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_9:
   \   000049   6009         JZ      ??MT_ProcessEvent_10
    125              {
    126                MT_SysOsalTimerExpired(0x00);
   \   00004B                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   00004B   7900         MOV     R1,#0x0
   \   00004D   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    127                events ^= MT_SYS_OSAL_EVENT_0;
   \   000050   7408         MOV     A,#0x8
   \   000052   6F           XRL     A,R7
   \   000053   FF           MOV     R7,A
    128              }
    129          
    130              if (events & MT_SYS_OSAL_EVENT_1)
   \                     ??MT_ProcessEvent_10:
   \   000054   7404         MOV     A,#0x4
   \   000056   5F           ANL     A,R7
   \   000057   F9           MOV     R1,A
   \   000058   E4           CLR     A
   \   000059   7001         JNZ     ??MT_ProcessEvent_11
   \   00005B   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_11:
   \   00005C   6009         JZ      ??MT_ProcessEvent_12
    131              {
    132                MT_SysOsalTimerExpired(0x01);
   \   00005E                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   00005E   7901         MOV     R1,#0x1
   \   000060   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    133                events ^= MT_SYS_OSAL_EVENT_1;
   \   000063   7404         MOV     A,#0x4
   \   000065   6F           XRL     A,R7
   \   000066   FF           MOV     R7,A
    134              }
    135          
    136              if (events & MT_SYS_OSAL_EVENT_2)
   \                     ??MT_ProcessEvent_12:
   \   000067   7402         MOV     A,#0x2
   \   000069   5F           ANL     A,R7
   \   00006A   F9           MOV     R1,A
   \   00006B   E4           CLR     A
   \   00006C   7001         JNZ     ??MT_ProcessEvent_13
   \   00006E   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_13:
   \   00006F   6009         JZ      ??MT_ProcessEvent_14
    137              {
    138                MT_SysOsalTimerExpired(0x02);
   \   000071                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000071   7902         MOV     R1,#0x2
   \   000073   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    139                events ^= MT_SYS_OSAL_EVENT_2;
   \   000076   7402         MOV     A,#0x2
   \   000078   6F           XRL     A,R7
   \   000079   FF           MOV     R7,A
    140              }
    141          
    142              if (events & MT_SYS_OSAL_EVENT_3)
   \                     ??MT_ProcessEvent_14:
   \   00007A   7401         MOV     A,#0x1
   \   00007C   5F           ANL     A,R7
   \   00007D   F9           MOV     R1,A
   \   00007E   E4           CLR     A
   \   00007F   7001         JNZ     ??MT_ProcessEvent_15
   \   000081   E9           MOV     A,R1
   \                     ??MT_ProcessEvent_15:
   \   000082   6009         JZ      ??MT_ProcessEvent_16
    143              {
    144                MT_SysOsalTimerExpired(0x03);
   \   000084                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000084   7903         MOV     R1,#0x3
   \   000086   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    145                events ^= MT_SYS_OSAL_EVENT_3;
   \   000089   7401         MOV     A,#0x1
   \   00008B   6F           XRL     A,R7
   \   00008C   FF           MOV     R7,A
    146              }
    147          
    148              return events;
   \                     ??MT_ProcessEvent_16:
   \   00008D   EE           MOV     A,R6
   \   00008E   FA           MOV     R2,A
   \   00008F   EF           MOV     A,R7
   \   000090   80A2         SJMP    ??MT_ProcessEvent_6
    149            }
    150          #endif
    151          
    152            /* Discard or make more handlers */
    153            return 0;
   \                     ??MT_ProcessEvent_8:
   \   000092   7A00         MOV     R2,#0x0
   \   000094   7B00         MOV     R3,#0x0
   \                     ??MT_ProcessEvent_3:
   \   000096   7F02         MOV     R7,#0x2
   \   000098   02....       LJMP    ?BANKED_LEAVE_XDATA
    154          
    155          } /* MT_ProcessEvent() */
    156          
    157          /***************************************************************************************************
    158           * @fn      MT_ProcessIncomingCommand
    159           *
    160           * @brief
    161           *
    162           *   Process Event Messages.
    163           *
    164           * @param   byte *msg - pointer to event message
    165           *
    166           * @return
    167           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    168          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg )
   \                     MT_ProcessIncomingCommand:
    169          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
    170            byte deallocate;
    171            byte *msg_ptr;
    172            byte len;
    173          
    174            /* A little setup for AF, CB_FUNC and MT_SYS_APP_RSP_MSG */
    175            msg_ptr = msg->msg;
   \   000009   EA           MOV     A,R2
   \   00000A   2402         ADD     A,#0x2
   \   00000C   F8           MOV     R0,A
   \   00000D   EB           MOV     A,R3
   \   00000E   3400         ADDC    A,#0x0
   \   000010   F9           MOV     R1,A
   \   000011   8882         MOV     DPL,R0
   \   000013   8983         MOV     DPH,R1
   \   000015   E0           MOVX    A,@DPTR
   \   000016   FE           MOV     R6,A
   \   000017   A3           INC     DPTR
   \   000018   E0           MOVX    A,@DPTR
   \   000019   FF           MOV     R7,A
    176          
    177            deallocate = true;
    178          
    179            /* Use the first byte of the message as the command ID */
    180            switch ( msg->hdr.event )
   \   00001A   8A82         MOV     DPL,R2
   \   00001C   8B83         MOV     DPH,R3
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   12....       LCALL   ?UC_SWITCH_SPARSE
   \                     `?<Jumptable for MT_ProcessIncomingCommand>_0`:
   \   000022   00           DB        0
   \   000023   05           DB        5
   \   000024   01           DB        1
   \   000025   ....         DW        ??MT_ProcessIncomingCommand_0
   \   000027   02           DB        2
   \   000028   ....         DW        ??MT_ProcessIncomingCommand_1
   \   00002A   04           DB        4
   \   00002B   ....         DW        ??MT_ProcessIncomingCommand_2
   \   00002D   06           DB        6
   \   00002E   ....         DW        ??MT_ProcessIncomingCommand_3
   \   000030   24           DB        36
   \   000031   ....         DW        ??MT_ProcessIncomingCommand_4
   \   000033   ....         DW        ??MT_ProcessIncomingCommand_5
    181            {
    182              case CMD_SERIAL_MSG:
    183                MT_ProcessIncoming(msg->msg);
   \                     ??MT_ProcessIncomingCommand_0:
   \   000035                ; Setup parameters for call to function MT_ProcessIncoming
   \   000035   8882         MOV     DPL,R0
   \   000037   8983         MOV     DPH,R1
   \   000039   E0           MOVX    A,@DPTR
   \   00003A   FA           MOV     R2,A
   \   00003B   A3           INC     DPTR
   \   00003C   E0           MOVX    A,@DPTR
   \   00003D   FB           MOV     R3,A
   \   00003E   12....       LCALL   ??MT_ProcessIncoming?relay
   \   000041   8063         SJMP    ??MT_ProcessIncomingCommand_5
    184                break;
    185          
    186              case CMD_DEBUG_MSG:
    187                MT_ProcessDebugMsg( (mtDebugMsg_t *)msg );
   \                     ??MT_ProcessIncomingCommand_1:
   \   000043                ; Setup parameters for call to function MT_ProcessDebugMsg
   \   000043   12....       LCALL   ??MT_ProcessDebugMsg?relay
   \   000046   805E         SJMP    ??MT_ProcessIncomingCommand_5
    188                break;
    189          
    190              case CMD_DEBUG_STR:
    191                MT_ProcessDebugStr( (mtDebugStr_t *)msg );
   \                     ??MT_ProcessIncomingCommand_3:
   \   000048                ; Setup parameters for call to function MT_ProcessDebugStr
   \   000048   12....       LCALL   ??MT_ProcessDebugStr?relay
   \   00004B   8059         SJMP    ??MT_ProcessIncomingCommand_5
    192                break;
    193          
    194              case CB_FUNC:
    195                /*
    196                  Build SPI message here instead of redundantly calling MT_BuildSPIMsg
    197                  because we have copied data already in the allocated message
    198                */
    199          
    200                /* msg_ptr is the beginning of the intended SPI message */
    201                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
   \                     ??MT_ProcessIncomingCommand_2:
   \   00004D   8E82         MOV     DPL,R6
   \   00004F   8F83         MOV     DPH,R7
   \   000051   A3           INC     DPTR
   \   000052   A3           INC     DPTR
   \   000053   A3           INC     DPTR
   \   000054   E0           MOVX    A,@DPTR
   \   000055   2405         ADD     A,#0x5
   \   000057   F5..         MOV     ?V0 + 2,A
    202          
    203                /*
    204                  FCS goes to the last byte in the message and is calculated over all
    205                  the bytes except FCS and SOP
    206                */
    207                msg_ptr[len-1] = MT_UartCalcFCS(msg_ptr + 1, (byte)(len-2));
   \   000059                ; Setup parameters for call to function MT_UartCalcFCS
   \   000059   74FE         MOV     A,#-0x2
   \   00005B   25..         ADD     A,?V0 + 2
   \   00005D   F9           MOV     R1,A
   \   00005E   8E82         MOV     DPL,R6
   \   000060   8F83         MOV     DPH,R7
   \   000062   A3           INC     DPTR
   \   000063   AA82         MOV     R2,DPL
   \   000065   AB83         MOV     R3,DPH
   \   000067   12....       LCALL   ??MT_UartCalcFCS?relay
   \   00006A   E9           MOV     A,R1
   \   00006B   C0E0         PUSH    A
   \   00006D   85....       MOV     ?V0 + 4,?V0 + 2
   \   000070   EE           MOV     A,R6
   \   000071   25..         ADD     A,?V0 + 4
   \   000073   F8           MOV     R0,A
   \   000074   EF           MOV     A,R7
   \   000075   3400         ADDC    A,#0x0
   \   000077   F9           MOV     R1,A
   \   000078   74FF         MOV     A,#-0x1
   \   00007A   28           ADD     A,R0
   \   00007B   F582         MOV     DPL,A
   \   00007D   74FF         MOV     A,#-0x1
   \   00007F   39           ADDC    A,R1
   \   000080   F583         MOV     DPH,A
   \   000082   D0E0         POP     A
   \   000084   F0           MOVX    @DPTR,A
    208          
    209          #ifdef MT_UART_DEFAULT_PORT
    210                HalUARTWrite ( MT_UART_DEFAULT_PORT, msg_ptr, len );
   \   000085                ; Setup parameters for call to function HalUARTWrite
   \   000085   AC..         MOV     R4,?V0 + 2
   \   000087   7D00         MOV     R5,#0x0
   \   000089   EE           MOV     A,R6
   \   00008A   FA           MOV     R2,A
   \   00008B   EF           MOV     A,R7
   \   00008C   FB           MOV     R3,A
   \   00008D   7900         MOV     R1,#0x0
   \   00008F   12....       LCALL   ??HalUARTWrite?relay
   \   000092   8012         SJMP    ??MT_ProcessIncomingCommand_5
    211          #endif
    212                break;
    213          
    214          #if !defined ( NONWK )
    215              case MT_SYS_APP_RSP_MSG:
    216                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    217                MTProcessAppRspMsg( msg_ptr, len );
   \                     ??MT_ProcessIncomingCommand_4:
   \   000094                ; Setup parameters for call to function MTProcessAppRspMsg
   \   000094   8E82         MOV     DPL,R6
   \   000096   8F83         MOV     DPH,R7
   \   000098   A3           INC     DPTR
   \   000099   A3           INC     DPTR
   \   00009A   A3           INC     DPTR
   \   00009B   E0           MOVX    A,@DPTR
   \   00009C   2405         ADD     A,#0x5
   \   00009E   F9           MOV     R1,A
   \   00009F   EE           MOV     A,R6
   \   0000A0   FA           MOV     R2,A
   \   0000A1   EF           MOV     A,R7
   \   0000A2   FB           MOV     R3,A
   \   0000A3   12....       LCALL   ??MTProcessAppRspMsg?relay
    218                break;
    219          #endif  // NONWK
    220          
    221              default:
    222                break;
    223            }
    224          
    225            if ( deallocate )
    226            {
    227              osal_msg_deallocate( (uint8 *)msg );
   \                     ??MT_ProcessIncomingCommand_5:
   \   0000A6                ; Setup parameters for call to function osal_msg_deallocate
   \   0000A6   AA..         MOV     R2,?V0 + 0
   \   0000A8   AB..         MOV     R3,?V0 + 1
   \   0000AA   12....       LCALL   ??osal_msg_deallocate?relay
    228            }
    229          }
   \   0000AD   7F06         MOV     R7,#0x6
   \   0000AF   02....       LJMP    ?BANKED_LEAVE_XDATA
    230          
    231          #ifdef MT_TASK
    232          /***************************************************************************************************
    233           * @fn      MT_TransportAlloc
    234           *
    235           * @brief   Allocate memory for transport msg
    236           *
    237           * @param   uint8 cmd0 - The first byte of the MT command id containing the command type and subsystem.
    238           *          uint8 len - length
    239           *
    240           * @return  pointer the allocated memory or NULL if fail to allocate the memory
    241           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    242          uint8 *MT_TransportAlloc(uint8 cmd0, uint8 len)
   \                     MT_TransportAlloc:
    243          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    244            uint8 *p;
    245          
    246            (void)cmd0;  // Intentionally unreferenced parameter
    247            
    248            /* Allocate a buffer of data length + SOP+CMD+FCS (5bytes) */
    249            p = osal_msg_allocate(len + SPI_0DATA_MSG_LEN);
   \   000005                ; Setup parameters for call to function osal_msg_allocate
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   7405         MOV     A,#0x5
   \   000009   25..         ADD     A,?V0 + 0
   \   00000B   FA           MOV     R2,A
   \   00000C   E4           CLR     A
   \   00000D   3400         ADDC    A,#0x0
   \   00000F   FB           MOV     R3,A
   \   000010   12....       LCALL   ??osal_msg_allocate?relay
   \   000013   8A82         MOV     DPL,R2
   \   000015   8B83         MOV     DPH,R3
    250          
    251            if (p)
   \   000017   E582         MOV     A,DPL
   \   000019   7002         JNZ     ??MT_TransportAlloc_0
   \   00001B   E583         MOV     A,DPH
   \                     ??MT_TransportAlloc_0:
   \   00001D   6007         JZ      ??MT_TransportAlloc_1
    252            {
    253              p++; /* Save space for SOP_VALUE, msg structure */
    254              return p;
   \   00001F   A3           INC     DPTR
   \   000020   AA82         MOV     R2,DPL
   \   000022   AB83         MOV     R3,DPH
   \   000024   8004         SJMP    ??MT_TransportAlloc_2
    255            }
    256            else
    257            {
    258              return NULL;
   \                     ??MT_TransportAlloc_1:
   \   000026   7A00         MOV     R2,#0x0
   \   000028   7B00         MOV     R3,#0x0
   \                     ??MT_TransportAlloc_2:
   \   00002A   7F02         MOV     R7,#0x2
   \   00002C   02....       LJMP    ?BANKED_LEAVE_XDATA
    259            }
    260          }
    261          
    262          /***************************************************************************************************
    263           * @fn      MT_TransportSend
    264           *
    265           * @brief   Fill in SOP and FCS then send out the msg
    266           *
    267           * @param   uint8 *pBuf - pointer to the message that contains CMD, length, data and FCS
    268           *
    269           * @return  None
    270           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    271          void MT_TransportSend(uint8 *pBuf)
   \                     MT_TransportSend:
    272          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    273            uint8 *msgPtr;
    274            uint8 dataLen = pBuf[0]; /* Data length is on byte #1 from the pointer */
   \   000005   8A82         MOV     DPL,R2
   \   000007   8B83         MOV     DPH,R3
   \   000009   E0           MOVX    A,@DPTR
   \   00000A   FC           MOV     R4,A
    275          
    276            /* Move back to the SOP */
    277            msgPtr = pBuf-1;
   \   00000B   EA           MOV     A,R2
   \   00000C   24FF         ADD     A,#-0x1
   \   00000E   F5..         MOV     ?V0 + 0,A
   \   000010   EB           MOV     A,R3
   \   000011   34FF         ADDC    A,#-0x1
   \   000013   F5..         MOV     ?V0 + 1,A
    278          
    279            /* Insert SOP */
    280            msgPtr[0] = MT_UART_SOF;
   \   000015   74FE         MOV     A,#-0x2
   \   000017   85..82       MOV     DPL,?V0 + 0
   \   00001A   85..83       MOV     DPH,?V0 + 1
   \   00001D   F0           MOVX    @DPTR,A
    281          
    282            /* Insert FCS */
    283            msgPtr[SPI_0DATA_MSG_LEN - 1 + dataLen] = MT_UartCalcFCS (pBuf, (3 + dataLen));
   \   00001E   8C82         MOV     DPL,R4
   \   000020   AE82         MOV     R6,DPL
   \   000022                ; Setup parameters for call to function MT_UartCalcFCS
   \   000022   7403         MOV     A,#0x3
   \   000024   2C           ADD     A,R4
   \   000025   F9           MOV     R1,A
   \   000026   12....       LCALL   ??MT_UartCalcFCS?relay
   \   000029   E9           MOV     A,R1
   \   00002A   C0E0         PUSH    A
   \   00002C   E5..         MOV     A,?V0 + 0
   \   00002E   2E           ADD     A,R6
   \   00002F   F582         MOV     DPL,A
   \   000031   E5..         MOV     A,?V0 + 1
   \   000033   3400         ADDC    A,#0x0
   \   000035   F583         MOV     DPH,A
   \   000037   A3           INC     DPTR
   \   000038   A3           INC     DPTR
   \   000039   A3           INC     DPTR
   \   00003A   A3           INC     DPTR
   \   00003B   D0E0         POP     A
   \   00003D   F0           MOVX    @DPTR,A
    284          
    285            /* Send to UART */
    286          #ifdef MT_UART_DEFAULT_PORT
    287            HalUARTWrite(MT_UART_DEFAULT_PORT, msgPtr, dataLen + SPI_0DATA_MSG_LEN);
   \   00003E                ; Setup parameters for call to function HalUARTWrite
   \   00003E   7405         MOV     A,#0x5
   \   000040   2E           ADD     A,R6
   \   000041   FC           MOV     R4,A
   \   000042   E4           CLR     A
   \   000043   3400         ADDC    A,#0x0
   \   000045   FD           MOV     R5,A
   \   000046   AA..         MOV     R2,?V0 + 0
   \   000048   AB..         MOV     R3,?V0 + 1
   \   00004A   7900         MOV     R1,#0x0
   \   00004C   12....       LCALL   ??HalUARTWrite?relay
    288          #endif
    289          
    290            /* Deallocate */
    291            osal_msg_deallocate(msgPtr);
   \   00004F                ; Setup parameters for call to function osal_msg_deallocate
   \   00004F   AA..         MOV     R2,?V0 + 0
   \   000051   AB..         MOV     R3,?V0 + 1
   \   000053   12....       LCALL   ??osal_msg_deallocate?relay
    292          }
   \   000056   7F02         MOV     R7,#0x2
   \   000058   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TaskInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TaskInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_ProcessIncomingCommand?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_ProcessIncomingCommand

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportAlloc?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportAlloc

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportSend?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportSend
    293          #endif /* MT_TASK */
    294          /***************************************************************************************************
    295           ***************************************************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     MT_ProcessEvent                    0      0     10
       -> MT_ProcessIncomingCommand     0      0     20
       -> osal_msg_receive              0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
     MT_ProcessIncomingCommand          1      0     24
       -> MT_ProcessIncoming            0      0     28
       -> MT_ProcessDebugMsg            0      0     28
       -> MT_ProcessDebugStr            0      0     28
       -> MT_UartCalcFCS                0      0     28
       -> HalUARTWrite                  0      0     28
       -> MTProcessAppRspMsg            0      0     28
       -> osal_msg_deallocate           0      0     28
     MT_TaskInit                        0      0      9
       -> MT_Init                       0      0     18
       -> MT_UartInit                   0      0     18
       -> MT_UartRegisterTaskID         0      0     18
     MT_TransportAlloc                  0      0     10
       -> osal_msg_allocate             0      0     20
     MT_TransportSend                   1      0     10
       -> MT_UartCalcFCS                0      0     20
       -> HalUARTWrite                  0      0     20
       -> osal_msg_deallocate           0      0     20


   Segment part sizes:

     Function/Label                    Bytes
     --------------                    -----
     MT_TaskInit                         23
     MT_ProcessEvent                    155
     MT_ProcessIncomingCommand          178
     MT_TransportAlloc                   47
     MT_TransportSend                    91
     ??MT_TaskInit?relay                  6
     ??MT_ProcessEvent?relay              6
     ??MT_ProcessIncomingCommand?relay    6
     ??MT_TransportAlloc?relay            6
     ??MT_TransportSend?relay             6

 
 494 bytes in segment BANKED_CODE
  30 bytes in segment BANK_RELAYS
 
 524 bytes of CODE memory

Errors: none
Warnings: none
