###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                08/Apr/2013  11:22:20 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Com #
#                          ponents\stack\zdo\ZDNwkMgr.c                       #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0 #
#                          \Projects\zstack\Samples\WSN_sensors\CC2530DB\..\. #
#                          .\..\Tools\CC2530DB\f8wRouter.cfg" (-DCPU32MHZ     #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DRTR_NWK -DBLINK_LEDS) -f "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\Tools\CC #
#                          2530DB\f8wConfig.cfg" (-DSECURE=0                  #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Co #
#                          mponents\stack\zdo\ZDNwkMgr.c" -D ZTOOL_P1 -D      #
#                          MT_TASK -D MT_SYS_FUNC -D MT_ZDO_FUNC -D           #
#                          LCD_SUPPORTED=DEBUG -lC "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\RouterEB\List\"   #
#                          -lA "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3. #
#                          0\Projects\zstack\Samples\WSN_sensors\CC2530DB\Rou #
#                          terEB\List\" --diag_suppress Pe001,Pa010 -o        #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pr #
#                          ojects\zstack\Samples\WSN_sensors\CC2530DB\RouterE #
#                          B\Obj\" -e --require_prototypes --no_unroll        #
#                          --no_inline --no_tbaa --debug --core=plain         #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 8 -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\" -I "C:\Texas    #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\SOURCE\" -I    #
#                          "C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pr #
#                          ojects\zstack\Samples\WSN_sensors\CC2530DB\..\..\. #
#                          .\ZMAIN\TI2530DB\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MT\" -I "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\HAL\INCLUDE\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\HAL\TARGET\CC2530EB\" -I "C:\Texas        #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\OSAL\MCU\CCSOC\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\OSAL\INCLUDE\" -I "C:\Texas               #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\AF\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\NWK\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SEC\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SAPI\" -I "C:\Texas                 #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\SYS\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\STACK\ZDO\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\ZMAC\F8W\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\ZMAC\" -I "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\SERVICES\SADDR\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\SERVICES\SDATA\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\INCLUDE\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\HIGH_LEVEL\" -I "C:\Texas             #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\LOW_LEVEL\srf04\" -I "C:\Texas        #
#                          Instruments\ZStack-CC2530-2.2.2-1.3.0\Projects\zst #
#                          ack\Samples\WSN_sensors\CC2530DB\..\..\..\..\..\CO #
#                          MPONENTS\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\" -I      #
#                          "D:\Program Files\IAR Systems\Embedded Workbench   #
#                          5.3\8051\INC\" -I "D:\Program Files\IAR            #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\" -Om #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pro #
#                          jects\zstack\Samples\WSN_sensors\CC2530DB\RouterEB #
#                          \List\ZDNwkMgr.lst                                 #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Pro #
#                          jects\zstack\Samples\WSN_sensors\CC2530DB\RouterEB #
#                          \Obj\ZDNwkMgr.r51                                  #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.2.2-1.3.0\Components\stack\zdo\ZDNwkMgr.c
      1          /**************************************************************************************************
      2            Filename:       ZDNwkMgr.c
      3            Revised:        $Date: 2007-10-17 15:38:45 -0700 (Wed, 17 Oct 2007) $
      4            Revision:       $Revision: 15716 $
      5          
      6            Description:    The ZigBee Network Manager.
      7          
      8          
      9            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          #ifdef __cplusplus
     41          extern "C"
     42          {
     43          #endif
     44          
     45          /******************************************************************************
     46           * INCLUDES
     47           */
     48          #include "ZComdef.h"
     49          #include "nwk_util.h"
     50          #include "ZDApp.h"
     51          #include "ZDObject.h"
     52          #include "ZGlobals.h"
     53          #include "ZDNwkMgr.h"
     54          
     55          #if defined( MT_ZDO_FUNC )
     56            #include "MT_ZDO.h"
     57          #endif
     58            
     59          #if defined ( LCD_SUPPORTED )
     60            #include "OnBoard.h"
     61          #endif
     62          
     63          /* HAL */
     64          #include "hal_lcd.h"
     65            
     66          /******************************************************************************
     67           * CONSTANTS
     68           */
     69          
     70          #define ONE_MINUTE             60000  // 1(m) * 60(s) * 1000(ms)
     71          
     72          #if defined ( LCD_SUPPORTED )

   \                                 In  segment XDATA_ROM_C, align 1
     73            const char NwkMgrStr_1[]     = "NM-fail not hi";
   \                     NwkMgrStr_1:
   \   000000   4E4D2D66     DB "NM-fail not hi"
   \            61696C20
   \            6E6F7420
   \            686900  

   \                                 In  segment XDATA_ROM_C, align 1
     74            const char NwkMgrStr_2[]     = "NM-cur<last fail";
   \                     NwkMgrStr_2:
   \   000000   4E4D2D63     DB "NM-cur<last fail"
   \            75723C6C
   \            61737420
   \            6661696C
   \            00      

   \                                 In  segment XDATA_ROM_C, align 1
     75            const char NwkMgrStr_3[]     = "NM-energy too hi";
   \                     NwkMgrStr_3:
   \   000000   4E4D2D65     DB "NM-energy too hi"
   \            6E657267
   \            7920746F
   \            6F206869
   \            00      

   \                                 In  segment XDATA_ROM_C, align 1
     76            const char NwkMgrStr_4[]     = "NM-energy not up";
   \                     NwkMgrStr_4:
   \   000000   4E4D2D65     DB "NM-energy not up"
   \            6E657267
   \            79206E6F
   \            74207570
   \            00      
     77          #endif
     78            
     79          /******************************************************************************
     80           * TYPEDEFS
     81           */
     82          
     83          /*********************************************************************
     84           * GLOBAL VARIABLES
     85           */
     86            
     87          // Task ID for internal task/event processing. This variable will be
     88          // received when ZDNwkMgr_Init() is called.

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     89          uint8 ZDNwkMgr_TaskID = 0;
   \                     ZDNwkMgr_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
     90          
     91          /******************************************************************************
     92           * LOCAL VARIABLES
     93           */
     94          
     95          // Frequency Agility variables

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     96          uint8 ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq = 0;
   \                     ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     97          zAddrType_t ZDNwkMgr_MgmtNwkUpdateNotifyAddr;
   \                     ZDNwkMgr_MgmtNwkUpdateNotifyAddr:
   \   000000                DS 9
   \   000009                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     98          uint16 ZDNwkMgr_UpdateNotifyTimer = 0;
   \                     ZDNwkMgr_UpdateNotifyTimer:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     99          uint8  ZDNwkMgr_NumUpdateNotifySent = 0;
   \                     ZDNwkMgr_NumUpdateNotifySent:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    100          uint8  ZDNwkMgr_WaitingForNotifyConfirm = FALSE;
   \                     ZDNwkMgr_WaitingForNotifyConfirm:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    101          uint16 ZDNwkMgr_TotalTransmissions;
   \                     ZDNwkMgr_TotalTransmissions:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    102          uint16 ZDNwkMgr_TxFailures;
   \                     ZDNwkMgr_TxFailures:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    103          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    104          ZDO_MgmtNwkUpdateReq_t ZDNwkMgr_MgmtNwkUpdateReq;
   \                     ZDNwkMgr_MgmtNwkUpdateReq:
   \   000000                DS 9
   \   000009                REQUIRE __INIT_XDATA_Z
    105            
    106          #if defined ( NWK_MANAGER )
    107          uint16 ZDNwkMgr_UpdateRequestTimer = 0;
    108          uint8  ZDNwkMgr_LastChannelEnergy = 0;
    109          uint16 ZDNwkMgr_LastChannelFailureRate = 0;
    110          #endif // NWK_MANAGER
    111          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    112          uint8 ZDNwkMgr_NewChannel;
   \                     ZDNwkMgr_NewChannel:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    113          
    114          // PAN ID Conflict variables
    115          #if defined ( NWK_MANAGER )
    116          uint8 ZDNwkMgr_PanIdUpdateInProgress = FALSE;
    117          #endif // NWK_MANAGER
    118          
    119          /*********************************************************************
    120           * GLOBAL FUNCTIONS
    121           */
    122          // Freguency Agility functions

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    123          void (*pZDNwkMgr_ReportChannelInterference)( NLME_ChanInterference_t *chanInterference ) = NULL;
   \                     pZDNwkMgr_ReportChannelInterference:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    124          void (*pZDNwkMgr_ProcessDataConfirm)( afDataConfirm_t *afDataConfirm ) = NULL;
   \                     pZDNwkMgr_ProcessDataConfirm:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    125          void (*pZDNwkMgr_EDScanConfirmCB)( NLME_EDScanConfirm_t *EDScanConfirm ) = NULL;
   \                     pZDNwkMgr_EDScanConfirmCB:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    126          
    127          // PAN ID Conflict functions

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    128          void (*pZDNwkMgr_NetworkReportCB)( ZDNwkMgr_NetworkReport_t *pReport ) = NULL;
   \                     pZDNwkMgr_NetworkReportCB:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    129          void (*pZDNwkMgr_NetworkUpdateCB)( ZDNwkMgr_NetworkUpdate_t *pUpdate ) = NULL;
   \                     pZDNwkMgr_NetworkUpdateCB:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    130          
    131          /******************************************************************************
    132           * LOCAL FUNCTIONS
    133           */
    134          
    135          void ZDNwkMgr_ProcessServerDiscRsp( zdoIncomingMsg_t *inMsg );
    136          void ZDNwkMgr_SetNwkManagerAddr( uint16 nwkManagerAddr );
    137          
    138          // Frequency Agility functions
    139          static void ZDNwkMgr_ProcessMsgCBs( zdoIncomingMsg_t *inMsg );
    140          
    141          static void ZDNwkMgr_ProcessMgmtNwkUpdateReq( zdoIncomingMsg_t *inMsg );
    142          static void ZDNwkMgr_ProcessChannelInterference( ZDNwkMgr_ChanInterference_t *pChanInterference );
    143          static void ZDNwkMgr_ProcessEDScanConfirm( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm );
    144          static void ZDNwkMgr_CheckForChannelInterference( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm );
    145          static void ZDNwkMgr_BuildAndSendUpdateNotify( uint8 TransSeq, zAddrType_t *dstAddr,
    146                                                         uint16 totalTransmissions, uint16 txFailures,
    147                                                         ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm, uint8 txOptions );
    148          void ZDNwkMgr_EDScanConfirmCB( NLME_EDScanConfirm_t *EDScanConfirm );
    149          void ZDNwkMgr_ProcessDataConfirm( afDataConfirm_t *afDataConfirm );
    150          void ZDNwkMgr_ReportChannelInterference( NLME_ChanInterference_t *chanInterference );
    151          
    152          #if defined ( NWK_MANAGER )
    153          static void ZDNwkMgr_ProcessMgmtNwkUpdateNotify( zdoIncomingMsg_t *inMsg );
    154          static void ZDNwkMgr_CheckForChannelChange( ZDO_MgmtNwkUpdateNotify_t *pNotify );
    155          #endif // NWK_MANAGER
    156          
    157          // PAN ID Conflict functions
    158          #if defined ( NWK_MANAGER )
    159          void ZDNwkMgr_NetworkReportCB( ZDNwkMgr_NetworkReport_t *pReport );
    160          void ZDNwkMgr_NetworkUpdateCB( ZDNwkMgr_NetworkUpdate_t *pUpdate );
    161          
    162          void ZDNwkMgr_ProcessNetworkReport( ZDNwkMgr_NetworkReport_t *pNetworkReport );
    163          void ZDNwkMgr_ProcessNetworkUpdate( ZDNwkMgr_NetworkUpdate_t *pNetworkUpdate );
    164          #endif // NWK_MANAGER
    165          
    166          /*********************************************************************
    167           * @fn      ZDNwkMgr_Init
    168           *
    169           * @brief   Initialization function for the Network Manager Task.
    170           *          This is called during initialization and should contain
    171           *          any application specific initialization (ie. hardware
    172           *          initialization/setup, table initialization, power up
    173           *          notificaiton ... ).
    174           *
    175           * @param   task_id - the ID assigned by OSAL.  This ID should be
    176           *                    used to send messages and set timers.
    177           *
    178           * @return  none
    179           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    180          void ZDNwkMgr_Init( byte task_id )
   \                     ZDNwkMgr_Init:
    181          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    182            // Save the task ID
    183            ZDNwkMgr_TaskID = task_id;
   \   000004   E9           MOV     A,R1
   \   000005   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   000008   F0           MOVX    @DPTR,A
    184          
    185            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Server_Discovery_rsp );
   \   000009                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   000009   7A15         MOV     R2,#0x15
   \   00000B   7B80         MOV     R3,#-0x80
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   F9           MOV     R1,A
   \   00000F   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    186          
    187            // Frequecy Agility initialization
    188            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Mgmt_NWK_Update_req );
   \   000012                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   000012   7A38         MOV     R2,#0x38
   \   000014   7B00         MOV     R3,#0x0
   \   000016   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   F9           MOV     R1,A
   \   00001B   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    189          #if defined ( NWK_MANAGER )
    190            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Mgmt_NWK_Update_notify );
    191          #endif // NWK_MANAGER
    192          
    193            pZDNwkMgr_EDScanConfirmCB = ZDNwkMgr_EDScanConfirmCB;
   \   00001E   90....       MOV     DPTR,#pZDNwkMgr_EDScanConfirmCB
   \   000021   74..         MOV     A,#(??ZDNwkMgr_EDScanConfirmCB?relay & 0xff)
   \   000023   F0           MOVX    @DPTR,A
   \   000024   A3           INC     DPTR
   \   000025   74..         MOV     A,#((??ZDNwkMgr_EDScanConfirmCB?relay >> 8) & 0xff)
   \   000027   F0           MOVX    @DPTR,A
    194            pZDNwkMgr_ProcessDataConfirm = ZDNwkMgr_ProcessDataConfirm;
   \   000028   90....       MOV     DPTR,#pZDNwkMgr_ProcessDataConfirm
   \   00002B   74..         MOV     A,#(??ZDNwkMgr_ProcessDataConfirm?relay & 0xff)
   \   00002D   F0           MOVX    @DPTR,A
   \   00002E   A3           INC     DPTR
   \   00002F   74..         MOV     A,#((??ZDNwkMgr_ProcessDataConfirm?relay >> 8) & 0xff)
   \   000031   F0           MOVX    @DPTR,A
    195            pZDNwkMgr_ReportChannelInterference = ZDNwkMgr_ReportChannelInterference;
   \   000032   90....       MOV     DPTR,#pZDNwkMgr_ReportChannelInterference
   \   000035   74..         MOV     A,#(??ZDNwkMgr_ReportChannelInterference?relay & 0xff)
   \   000037   F0           MOVX    @DPTR,A
   \   000038   A3           INC     DPTR
   \   000039   74..         MOV     A,#((??ZDNwkMgr_ReportChannelInterference?relay >> 8) & 0xff)
   \   00003B   F0           MOVX    @DPTR,A
    196            
    197            // PAN ID Conflict initialization
    198          #if defined ( NWK_MANAGER )
    199            pZDNwkMgr_NetworkReportCB = ZDNwkMgr_NetworkReportCB;
    200            pZDNwkMgr_NetworkUpdateCB = ZDNwkMgr_NetworkUpdateCB;
    201          #endif // NWK_MANAGER
    202            
    203            ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addrMode = Addr16Bit;
   \   00003C   7402         MOV     A,#0x2
   \   00003E   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateNotifyAddr + 8)
   \   000041   F0           MOVX    @DPTR,A
    204            ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = INVALID_NODE_ADDR;
   \   000042   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyAddr
   \   000045   74FE         MOV     A,#-0x2
   \   000047   F0           MOVX    @DPTR,A
   \   000048   A3           INC     DPTR
   \   000049   74FF         MOV     A,#-0x1
   \   00004B   F0           MOVX    @DPTR,A
    205          }
   \   00004C   D083         POP     DPH
   \   00004E   D082         POP     DPL
   \   000050   02....       LJMP    ?BRET
    206          
    207          /*********************************************************************
    208           * @fn      ZDNwkMgr_event_loop
    209           *
    210           * @brief   Main event loop for the Network Manager task. This function
    211           *          is called to process all events for the task.  Events
    212           *          include timers, messages and any other user defined events.
    213           *
    214           * @param   task_id  - The OSAL assigned task ID.
    215           * @param   events - events to process.  This is a bit map and can
    216           *                   contain more than one event.
    217           *
    218           * @return  none
    219           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    220          UINT16 ZDNwkMgr_event_loop( byte task_id, UINT16 events )
   \                     ZDNwkMgr_event_loop:
    221          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    222            osal_event_hdr_t *msgPtr;
    223            (void)task_id;  // Intentionally unreferenced parameter
    224          
    225            if ( events & SYS_EVENT_MSG )
   \   000009   7480         MOV     A,#-0x80
   \   00000B   5F           ANL     A,R7
   \   00000C   F9           MOV     R1,A
   \   00000D   E4           CLR     A
   \   00000E   7001         JNZ     ??ZDNwkMgr_event_loop_0
   \   000010   E9           MOV     A,R1
   \                     ??ZDNwkMgr_event_loop_0:
   \   000011   6056         JZ      ??ZDNwkMgr_event_loop_1
    226            {
    227              msgPtr = (osal_event_hdr_t *)osal_msg_receive( ZDNwkMgr_TaskID );
   \   000013                ; Setup parameters for call to function osal_msg_receive
   \   000013   800E         SJMP    ??ZDNwkMgr_event_loop_2
    228              while ( msgPtr )
    229              {
    230                switch ( msgPtr->event )
    231                {
    232                  case ZDO_CB_MSG:
    233                    // ZDO sends the message that we registered for
    234                    ZDNwkMgr_ProcessMsgCBs( (zdoIncomingMsg_t *)msgPtr );
    235                    break;
    236                   
    237                  case NM_CHANNEL_INTERFERE:
    238                    // NWK layer sends the message when it detectes Channel Interference
    239                    ZDNwkMgr_ProcessChannelInterference( (ZDNwkMgr_ChanInterference_t *)msgPtr );
    240                    break;
    241             
    242                  case NM_ED_SCAN_CONFIRM:
    243                    // NWK layer sends the message when it receives an ED scan confirmation
    244                    ZDNwkMgr_ProcessEDScanConfirm( (ZDNwkMgr_EDScanConfirm_t *)msgPtr );
   \                     ??ZDNwkMgr_event_loop_3:
   \   000015                ; Setup parameters for call to function ZDNwkMgr_ProcessEDScanConfirm
   \   000015   AA..         MOV     R2,?V0 + 0
   \   000017   AB..         MOV     R3,?V0 + 1
   \   000019   12....       LCALL   ??ZDNwkMgr_ProcessEDScanConfirm?relay
    245                    break;
    246          #if defined ( NWK_MANAGER )
    247                  case ZDO_NETWORK_REPORT:
    248                    // NWK layer sends this message when it receives a Network Report message
    249                    ZDNwkMgr_ProcessNetworkReport( (ZDNwkMgr_NetworkReport_t *)msgPtr );
    250                    break;
    251                 
    252                  case ZDO_NETWORK_UPDATE:
    253                    // NKW layer sends this message when it receives a Network Update message
    254                    ZDNwkMgr_ProcessNetworkUpdate( (ZDNwkMgr_NetworkUpdate_t *)msgPtr );
    255                    break;
    256          #endif // NWK_MANAGER         
    257                  default:
    258                    break;
    259                }
    260          
    261                // Release the memory
    262                osal_msg_deallocate( (uint8 *)msgPtr );
   \                     ??ZDNwkMgr_event_loop_4:
   \   00001C                ; Setup parameters for call to function osal_msg_deallocate
   \   00001C   AA..         MOV     R2,?V0 + 0
   \   00001E   AB..         MOV     R3,?V0 + 1
   \   000020   12....       LCALL   ??osal_msg_deallocate?relay
    263          
    264                // Next
    265                msgPtr = (osal_event_hdr_t *)osal_msg_receive( ZDNwkMgr_TaskID );
   \   000023                ; Setup parameters for call to function osal_msg_receive
   \                     ??ZDNwkMgr_event_loop_2:
   \   000023   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   000026   E0           MOVX    A,@DPTR
   \   000027   F9           MOV     R1,A
   \   000028   12....       LCALL   ??osal_msg_receive?relay
   \   00002B   8A..         MOV     ?V0 + 0,R2
   \   00002D   8B..         MOV     ?V0 + 1,R3
   \   00002F   E5..         MOV     A,?V0 + 0
   \   000031   7002         JNZ     ??ZDNwkMgr_event_loop_5
   \   000033   E5..         MOV     A,?V0 + 1
   \                     ??ZDNwkMgr_event_loop_5:
   \   000035   6029         JZ      ??ZDNwkMgr_event_loop_6
   \   000037   85..82       MOV     DPL,?V0 + 0
   \   00003A   85..83       MOV     DPH,?V0 + 1
   \   00003D   E0           MOVX    A,@DPTR
   \   00003E   12....       LCALL   ?UC_SWITCH_SPARSE
   \                     `?<Jumptable for ZDNwkMgr_event_loop>_0`:
   \   000041   00           DB        0
   \   000042   03           DB        3
   \   000043   31           DB        49
   \   000044   ....         DW        ??ZDNwkMgr_event_loop_7
   \   000046   32           DB        50
   \   000047   ....         DW        ??ZDNwkMgr_event_loop_3
   \   000049   D3           DB        211
   \   00004A   ....         DW        ??ZDNwkMgr_event_loop_8
   \   00004C   ....         DW        ??ZDNwkMgr_event_loop_4
   \                     ??ZDNwkMgr_event_loop_8:
   \   00004E                ; Setup parameters for call to function ZDNwkMgr_ProcessMsgCBs
   \   00004E   AA..         MOV     R2,?V0 + 0
   \   000050   AB..         MOV     R3,?V0 + 1
   \   000052   12....       LCALL   ??ZDNwkMgr_ProcessMsgCBs?relay
   \   000055   80C5         SJMP    ??ZDNwkMgr_event_loop_4
   \                     ??ZDNwkMgr_event_loop_7:
   \   000057                ; Setup parameters for call to function ZDNwkMgr_ProcessChannelInterference
   \   000057   AA..         MOV     R2,?V0 + 0
   \   000059   AB..         MOV     R3,?V0 + 1
   \   00005B   12....       LCALL   ??ZDNwkMgr_ProcessChannelInterference?relay
   \   00005E   80BC         SJMP    ??ZDNwkMgr_event_loop_4
    266              }
    267              
    268              // Return unprocessed events
    269              return (events ^ SYS_EVENT_MSG);
   \                     ??ZDNwkMgr_event_loop_6:
   \   000060   EE           MOV     A,R6
   \   000061   FA           MOV     R2,A
   \   000062   7480         MOV     A,#-0x80
   \   000064   6F           XRL     A,R7
   \                     ??ZDNwkMgr_event_loop_9:
   \   000065   FB           MOV     R3,A
   \   000066   02....       LJMP    ??ZDNwkMgr_event_loop_10 & 0xFFFF
    270            }
    271          
    272            if ( events & ZDNWKMGR_CHANNEL_CHANGE_EVT )
   \                     ??ZDNwkMgr_event_loop_1:
   \   000069   EE           MOV     A,R6
   \   00006A   A2E0         MOV     C,0xE0 /* A   */.0
   \   00006C   5027         JNC     ??ZDNwkMgr_event_loop_11
    273            {       
    274              // Switch channel
    275              _NIB.nwkLogicalChannel = ZDNwkMgr_NewChannel;
   \   00006E   90....       MOV     DPTR,#ZDNwkMgr_NewChannel
   \   000071   E0           MOVX    A,@DPTR
   \   000072   90....       MOV     DPTR,#(_NIB + 22)
   \   000075   F0           MOVX    @DPTR,A
    276              ZMacSetReq( ZMacChannel, &ZDNwkMgr_NewChannel );
   \   000076                ; Setup parameters for call to function ZMacSetReq
   \   000076   7A..         MOV     R2,#(ZDNwkMgr_NewChannel & 0xff)
   \   000078   7B..         MOV     R3,#((ZDNwkMgr_NewChannel >> 8) & 0xff)
   \   00007A   79E1         MOV     R1,#-0x1f
   \   00007C   12....       LCALL   ??ZMacSetReq?relay
    277           
    278              // Our Channel has been changed -- notify to save info into NV
    279              ZDApp_NwkStateUpdateCB();
   \   00007F                ; Setup parameters for call to function ZDApp_NwkStateUpdateCB
   \   00007F   12....       LCALL   ??ZDApp_NwkStateUpdateCB?relay
    280              
    281              // Reset the total transmit count and the transmit failure counters
    282              _NIB.nwkTotalTransmissions = 0;
   \   000082   90....       MOV     DPTR,#(_NIB + 107)
   \   000085   E4           CLR     A
   \   000086   F0           MOVX    @DPTR,A
   \   000087   A3           INC     DPTR
   \   000088   F0           MOVX    @DPTR,A
    283              nwkTransmissionFailures( TRUE );
   \   000089                ; Setup parameters for call to function nwkTransmissionFailures
   \   000089   7901         MOV     R1,#0x1
   \   00008B   12....       LCALL   ??nwkTransmissionFailures?relay
    284              
    285              return ( events ^ ZDNWKMGR_CHANNEL_CHANGE_EVT );
   \   00008E   7401         MOV     A,#0x1
   \                     ??ZDNwkMgr_event_loop_12:
   \   000090   6E           XRL     A,R6
   \   000091   FA           MOV     R2,A
   \   000092   EF           MOV     A,R7
   \   000093   80D0         SJMP    ??ZDNwkMgr_event_loop_9
    286            }
    287          
    288            if ( events & ZDNWKMGR_UPDATE_NOTIFY_EVT )
   \                     ??ZDNwkMgr_event_loop_11:
   \   000095   5402         ANL     A,#0x2
   \   000097   6031         JZ      ??ZDNwkMgr_event_loop_13
    289            {
    290              // Update the Update Notify timer
    291              if ( ZDNwkMgr_UpdateNotifyTimer > 0 )
   \   000099   90....       MOV     DPTR,#ZDNwkMgr_UpdateNotifyTimer
   \   00009C   E0           MOVX    A,@DPTR
   \   00009D   7002         JNZ     ??ZDNwkMgr_event_loop_14
   \   00009F   A3           INC     DPTR
   \   0000A0   E0           MOVX    A,@DPTR
   \                     ??ZDNwkMgr_event_loop_14:
   \   0000A1   601E         JZ      ??ZDNwkMgr_event_loop_15
    292              {
    293                ZDNwkMgr_UpdateNotifyTimer--;
   \   0000A3   90....       MOV     DPTR,#ZDNwkMgr_UpdateNotifyTimer
   \   0000A6   E0           MOVX    A,@DPTR
   \   0000A7   24FF         ADD     A,#-0x1
   \   0000A9   F0           MOVX    @DPTR,A
   \   0000AA   A3           INC     DPTR
   \   0000AB   E0           MOVX    A,@DPTR
   \   0000AC   34FF         ADDC    A,#-0x1
   \   0000AE   F0           MOVX    @DPTR,A
    294                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_NOTIFY_EVT, ONE_MINUTE );
   \   0000AF                ; Setup parameters for call to function osal_start_timerEx
   \   0000AF   7C60         MOV     R4,#0x60
   \   0000B1   7DEA         MOV     R5,#-0x16
   \   0000B3   7A02         MOV     R2,#0x2
   \   0000B5   7B00         MOV     R3,#0x0
   \   0000B7   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   0000BA   E0           MOVX    A,@DPTR
   \   0000BB   F9           MOV     R1,A
   \   0000BC   12....       LCALL   ??osal_start_timerEx?relay
   \   0000BF   8005         SJMP    ??ZDNwkMgr_event_loop_16
    295              }
    296              else
    297              {
    298                ZDNwkMgr_NumUpdateNotifySent = 0;
   \                     ??ZDNwkMgr_event_loop_15:
   \   0000C1   E4           CLR     A
   \   0000C2   90....       MOV     DPTR,#ZDNwkMgr_NumUpdateNotifySent
   \   0000C5   F0           MOVX    @DPTR,A
    299              }
    300              
    301              return ( events ^ ZDNWKMGR_UPDATE_NOTIFY_EVT );
   \                     ??ZDNwkMgr_event_loop_16:
   \   0000C6   7402         MOV     A,#0x2
   \   0000C8   80C6         SJMP    ??ZDNwkMgr_event_loop_12
    302            }
    303            
    304          #if defined ( NWK_MANAGER )
    305            if ( events & ZDNWKMGR_UPDATE_REQUEST_EVT )
    306            {
    307              // Update the Update Request timer
    308              if ( ZDNwkMgr_UpdateRequestTimer > 0 )
    309              {
    310                ZDNwkMgr_UpdateRequestTimer--;
    311                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_REQUEST_EVT, ONE_MINUTE );
    312              }
    313              
    314              return ( events ^ ZDNWKMGR_UPDATE_REQUEST_EVT );
    315            }
    316          #endif // NWK_MANAGER
    317            
    318            if ( events & ZDNWKMGR_SCAN_REQUEST_EVT )
   \                     ??ZDNwkMgr_event_loop_13:
   \   0000CA   EE           MOV     A,R6
   \   0000CB   5408         ANL     A,#0x8
   \   0000CD   602B         JZ      ??ZDNwkMgr_event_loop_17
    319            {  
    320              if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount > 0 )
   \   0000CF   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   0000D2   E0           MOVX    A,@DPTR
   \   0000D3   6021         JZ      ??ZDNwkMgr_event_loop_18
    321              {
    322                if (  NLME_EDScanRequest( ZDNwkMgr_MgmtNwkUpdateReq.channelMask, 
    323                                          ZDNwkMgr_MgmtNwkUpdateReq.scanDuration ) == ZSuccess )
   \   0000D5                ; Setup parameters for call to function NLME_EDScanRequest
   \   0000D5   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 4)
   \   0000D8   E0           MOVX    A,@DPTR
   \   0000D9   F9           MOV     R1,A
   \   0000DA   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateReq
   \   0000DD   78..         MOV     R0,#?V0 + 0
   \   0000DF   12....       LCALL   ?L_MOV_X
   \   0000E2   AA..         MOV     R2,?V0 + 0
   \   0000E4   AB..         MOV     R3,?V0 + 1
   \   0000E6   AC..         MOV     R4,?V0 + 2
   \   0000E8   AD..         MOV     R5,?V0 + 3
   \   0000EA   12....       LCALL   ??NLME_EDScanRequest?relay
   \   0000ED   E9           MOV     A,R1
   \   0000EE   7006         JNZ     ??ZDNwkMgr_event_loop_18
    324                {
    325                  ZDNwkMgr_MgmtNwkUpdateReq.scanCount--;
   \   0000F0   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   0000F3   E0           MOVX    A,@DPTR
   \   0000F4   14           DEC     A
   \   0000F5   F0           MOVX    @DPTR,A
    326                }
    327              }
    328                
    329              return ( events ^ ZDNWKMGR_SCAN_REQUEST_EVT );
   \                     ??ZDNwkMgr_event_loop_18:
   \   0000F6   7408         MOV     A,#0x8
   \   0000F8   8096         SJMP    ??ZDNwkMgr_event_loop_12
    330            }
    331            
    332            // Discard or make more handlers
    333            return 0;
   \                     ??ZDNwkMgr_event_loop_17:
   \   0000FA   7A00         MOV     R2,#0x0
   \   0000FC   7B00         MOV     R3,#0x0
   \                     ??ZDNwkMgr_event_loop_10:
   \   0000FE   7F04         MOV     R7,#0x4
   \   000100   02....       LJMP    ?BANKED_LEAVE_XDATA
    334          }
    335          
    336          /*********************************************************************
    337           * @fn      ZDNwkMgr_ProcessMsgCBs
    338           *
    339           * @brief   Process the incoming messages.
    340           *
    341           * @param   msgPtr - message to process
    342           *
    343           * @return  TRUE if message to be freed. FALSE otherwise.
    344           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    345          static void ZDNwkMgr_ProcessMsgCBs( zdoIncomingMsg_t *inMsg )
   \                     ZDNwkMgr_ProcessMsgCBs:
    346          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    347            switch ( inMsg->clusterID )
   \   000005   EA           MOV     A,R2
   \   000006   240C         ADD     A,#0xc
   \   000008   F582         MOV     DPL,A
   \   00000A   EB           MOV     A,R3
   \   00000B   3400         ADDC    A,#0x0
   \   00000D   F583         MOV     DPH,A
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   F5..         MOV     ?V0 + 0,A
   \   000012   A3           INC     DPTR
   \   000013   E0           MOVX    A,@DPTR
   \   000014   F5..         MOV     ?V0 + 1,A
   \   000016   78..         MOV     R0,#?V0 + 0
   \   000018   12....       LCALL   ?US_SWITCH_SPARSE
   \                     `?<Jumptable for ZDNwkMgr_ProcessMsgCBs>_0`:
   \   00001B   0000         DW        0
   \   00001D   0200         DW        2
   \   00001F   3800         DW        56
   \   000021   ....         DW        ??ZDNwkMgr_ProcessMsgCBs_0
   \   000023   1580         DW        32789
   \   000025   ....         DW        ??ZDNwkMgr_ProcessMsgCBs_1
   \   000027   ....         DW        ??ZDNwkMgr_ProcessMsgCBs_2
    348            {   
    349              case Mgmt_NWK_Update_req:
    350                ZDNwkMgr_ProcessMgmtNwkUpdateReq( inMsg );
   \                     ??ZDNwkMgr_ProcessMsgCBs_0:
   \   000029                ; Setup parameters for call to function ZDNwkMgr_ProcessMgmtNwkUpdateReq
   \   000029   12....       LCALL   ??ZDNwkMgr_ProcessMgmtNwkUpdateReq?relay
   \   00002C   8003         SJMP    ??ZDNwkMgr_ProcessMsgCBs_2
    351                break;    
    352          #if defined ( NWK_MANAGER )  
    353              case Mgmt_NWK_Update_notify:
    354                ZDNwkMgr_ProcessMgmtNwkUpdateNotify( inMsg );
    355                break;
    356          #endif // NWK_MANAGER
    357              case Server_Discovery_rsp:
    358                ZDNwkMgr_ProcessServerDiscRsp( inMsg );
   \                     ??ZDNwkMgr_ProcessMsgCBs_1:
   \   00002E                ; Setup parameters for call to function ZDNwkMgr_ProcessServerDiscRsp
   \   00002E   12....       LCALL   ??ZDNwkMgr_ProcessServerDiscRsp?relay
    359                break;
    360                
    361              default:
    362                // Unknown message
    363                break;
    364            }
    365          }
   \                     ??ZDNwkMgr_ProcessMsgCBs_2:
   \   000031   7F02         MOV     R7,#0x2
   \   000033   02....       LJMP    ?BANKED_LEAVE_XDATA
    366          
    367          /*********************************************************************
    368           * Frequency Agility Routines
    369           */
    370          #if defined ( NWK_MANAGER )
    371          /*********************************************************************
    372           * @fn          ZDNwkMgr_ProcessMgmtNwkUpdateNotify
    373           *
    374           * @brief       This function processes the incoming Management
    375           *              Network Update notify.
    376           *
    377           * @param       pUpdateNotify - notify message
    378           *
    379           * @return      TRUE if message to be freed. FALSE otherwise.
    380           */
    381          static void ZDNwkMgr_ProcessMgmtNwkUpdateNotify( zdoIncomingMsg_t *inMsg )
    382          {
    383            if ( zgNwkMgrMode == ZDNWKMGR_ENABLE )
    384            {
    385              ZDO_MgmtNwkUpdateNotify_t *pNotify = ZDO_ParseMgmtNwkUpdateNotify( inMsg ); 
    386              if ( pNotify )
    387              {
    388                ZDNwkMgr_CheckForChannelChange( pNotify );
    389          
    390                osal_mem_free( pNotify );
    391              }
    392            }
    393          }
    394          
    395          /*********************************************************************
    396           * @fn          ZDNwkMgr_CheckForChannelChange
    397           *
    398           * @brief       This function processes the incoming Management Network
    399           *              Update notify and starts an Update Request if a channel
    400           *              change is needed.
    401           *
    402           * @param       pUpdateNotify - notify message
    403           *
    404           * @return      none
    405           */
    406          static void ZDNwkMgr_CheckForChannelChange( ZDO_MgmtNwkUpdateNotify_t *pNotify )
    407          {
    408            uint8  i;
    409            uint16 failureRate;
    410            uint8  lowestEnergyIndex;
    411            uint8  lowestEnergyValue = 0xFF;
    412                
    413            // If any device has more than 50% transmission failures, a channel
    414            // change should be considered
    415            failureRate = ( pNotify->transmissionFailures * 100 ) / pNotify->totalTransmissions;
    416            if ( failureRate < ZDNWKMGR_CC_TX_FAILURE )
    417            {
    418          #if defined ( LCD_SUPPORTED )
    419              HalLcdWriteString( (char*)NwkMgrStr_1, HAL_LCD_LINE_1 );
    420              HalLcdWriteStringValueValue( ": ", failureRate, 10, ZDNWKMGR_CC_TX_FAILURE, 10, HAL_LCD_LINE_2 );
    421          #endif
    422              return;
    423            }
    424          
    425            // If the current failure rate is higher than the last failure rate,
    426            // a channel change should be considered
    427            if ( failureRate < ZDNwkMgr_LastChannelFailureRate )
    428            {
    429          #if defined ( LCD_SUPPORTED )
    430              HalLcdWriteString( (char*)NwkMgrStr_2, HAL_LCD_LINE_1 );
    431              HalLcdWriteStringValueValue( ": ", failureRate, 10, 
    432                                           ZDNwkMgr_LastChannelFailureRate, 10, HAL_LCD_LINE_2 );
    433          #endif
    434              return;
    435            }
    436            
    437            // Select a single channel based on the Mgmt_NWK_Update_notify based on
    438            // the lowest energy. This is the proposed new channel. 
    439            for ( i = 0; i < pNotify->listCount; i++ )
    440            {
    441              if ( pNotify->energyValues[i] < lowestEnergyValue )
    442              {
    443                lowestEnergyIndex = i;
    444                lowestEnergyValue = pNotify->energyValues[i];
    445              }
    446            }
    447                
    448            // If this new channel does not have an energy level below an acceptable
    449            // threshold, a channel change should not be done.
    450            if ( lowestEnergyValue > ZDNWKMGR_ACCEPTABLE_ENERGY_LEVEL )
    451            {
    452          #if defined ( LCD_SUPPORTED )
    453              HalLcdWriteString( (char*)NwkMgrStr_3, HAL_LCD_LINE_1 );
    454              HalLcdWriteStringValueValue( ": ", lowestEnergyValue, 10, 
    455                                           ZDNWKMGR_ACCEPTABLE_ENERGY_LEVEL, 10, HAL_LCD_LINE_2 );
    456          #endif
    457              return;
    458            }
    459          
    460            // Channel change should be done -- find out the new active channel
    461            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
    462            {
    463              if ( ( (uint32)1 << i ) & pNotify->scannedChannels )
    464              {
    465                if ( lowestEnergyIndex == 0 )
    466                  break;
    467                lowestEnergyIndex--;
    468              }
    469            }
    470            
    471            if ( ( _NIB.nwkLogicalChannel != i ) && ( ZDNwkMgr_UpdateRequestTimer == 0 ) )
    472            {
    473              uint32 channelMask;
    474              zAddrType_t dstAddr;
    475              
    476              // The new channel
    477              ZDNwkMgr_NewChannel = i;
    478                  
    479              // Prior to changing channels, the network manager should store the 
    480              // energy scan value as the last energy scan value and the failure 
    481              // rate from the existing channel as the last failure rate.  These 
    482              // values are useful to allow comparison of the failure rate and energy
    483              // level on the previous channel to evaluate if the network is causing
    484              // its own interference.
    485              ZDNwkMgr_LastChannelEnergy = lowestEnergyValue;
    486              ZDNwkMgr_LastChannelFailureRate = failureRate;
    487                 
    488              // The network manager should broadcast a Mgmt_NWK_Update_req notifying
    489              // devices of the new channel.  The broadcast shall be to all routers 
    490              // and coordinator.
    491              dstAddr.addrMode = AddrBroadcast;
    492              dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR_DEVRXON;
    493              channelMask = (uint32)1 << i;
    494                  
    495              // Increment the nwkUpdateId parameter and set the updateID in the beacon
    496              NLME_SetUpdateID(_NIB.nwkUpdateId + 1); 
    497              
    498              ZDP_MgmtNwkUpdateReq( &dstAddr, channelMask, 0xfe, 0, _NIB.nwkUpdateId, 0 );
    499                  
    500              // The network manager shall set a timer based on the value of 
    501              // apsChannelTimer upon issue of a Mgmt_NWK_Update_req that changes 
    502              // channels and shall not issue another such command until this 
    503              // timer expires.  
    504              ZDNwkMgr_UpdateRequestTimer = ZDNWKMGR_UPDATE_REQUEST_TIMER;
    505              osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_REQUEST_EVT, ONE_MINUTE );
    506                            
    507              // Upon receipt of a Mgmt_NWK_Update_req with a change of channels, 
    508              // the local network manager shall set a timer equal to the 
    509              // nwkNetworkBroadcastDeliveryTime and shall switch channels upon 
    510              // expiration of this timer.  NOTE: since we won't recevied our own
    511              // broadcasted Update Request, we start the channel change timer here.  
    512              osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_CHANNEL_CHANGE_EVT, 
    513                                  ZDNWKMGR_BCAST_DELIVERY_TIME );
    514            }
    515          }
    516          #endif  // NWK_MANAGER
    517          
    518          /*********************************************************************
    519           * @fn          ZDNwkMgr_ProcessMgmtNwkUpdateReq
    520           *
    521           * @brief       This function processes the incoming Management
    522           *              Network Update request and starts the request (if needed).
    523           *
    524           * @param       Request message
    525           *
    526           * @return      none
    527           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    528          static void ZDNwkMgr_ProcessMgmtNwkUpdateReq( zdoIncomingMsg_t *inMsg )
   \                     ZDNwkMgr_ProcessMgmtNwkUpdateReq:
    529          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 9
   \   000005   74F7         MOV     A,#-0x9
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    530            ZDO_MgmtNwkUpdateReq_t Req;
    531            
    532            ZDO_ParseMgmtNwkUpdateReq( inMsg, &Req );
   \   00000E                ; Setup parameters for call to function ZDO_ParseMgmtNwkUpdateReq
   \   00000E   85..82       MOV     DPL,?XSP + 0
   \   000011   85..83       MOV     DPH,?XSP + 1
   \   000014   AC82         MOV     R4,DPL
   \   000016   AD83         MOV     R5,DPH
   \   000018   12....       LCALL   ??ZDO_ParseMgmtNwkUpdateReq?relay
    533             
    534            if ( Req.scanDuration <= 0x05 )
   \   00001B   7404         MOV     A,#0x4
   \   00001D   12....       LCALL   ?XSTACK_DISP0_8
   \   000020   E0           MOVX    A,@DPTR
   \   000021   F9           MOV     R1,A
   \   000022   C3           CLR     C
   \   000023   9406         SUBB    A,#0x6
   \   000025   507B         JNC     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_0
    535            {
    536              // Request is to scan over channelMask. The result will be reported by Confirm   
    537              if ( ( !inMsg->wasBroadcast )                     && 
    538                   ( Req.scanCount >  ZDNWKMGR_MIN_SCAN_COUNT ) && 
    539                   ( Req.scanCount <= ZDNWKMGR_MAX_SCAN_COUNT ) )
   \   000027   EE           MOV     A,R6
   \   000028   240B         ADD     A,#0xb
   \   00002A   F582         MOV     DPL,A
   \   00002C   EF           MOV     A,R7
   \   00002D   3400         ADDC    A,#0x0
   \   00002F   F583         MOV     DPH,A
   \   000031   E0           MOVX    A,@DPTR
   \   000032   6003         JZ      $+5
   \   000034   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
   \   000037   7405         MOV     A,#0x5
   \   000039   12....       LCALL   ?XSTACK_DISP0_8
   \   00003C   E0           MOVX    A,@DPTR
   \   00003D   7003         JNZ     $+5
   \   00003F   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
   \   000042   C3           CLR     C
   \   000043   9406         SUBB    A,#0x6
   \   000045   4003         JC      $+5
   \   000047   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    540              {
    541                if ( NLME_EDScanRequest( Req.channelMask, Req.scanDuration ) == ZSuccess )
   \   00004A                ; Setup parameters for call to function NLME_EDScanRequest
   \   00004A   85..82       MOV     DPL,?XSP + 0
   \   00004D   85..83       MOV     DPH,?XSP + 1
   \   000050   78..         MOV     R0,#?V0 + 0
   \   000052   12....       LCALL   ?L_MOV_X
   \   000055   AA..         MOV     R2,?V0 + 0
   \   000057   AB..         MOV     R3,?V0 + 1
   \   000059   AC..         MOV     R4,?V0 + 2
   \   00005B   AD..         MOV     R5,?V0 + 3
   \   00005D   12....       LCALL   ??NLME_EDScanRequest?relay
   \   000060   E9           MOV     A,R1
   \   000061   6003         JZ      $+5
   \   000063   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    542                {
    543                  // Save off the information to be used for the notify
    544                  ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq            = inMsg->TransSeq;
   \   000066   EE           MOV     A,R6
   \   000067   240F         ADD     A,#0xf
   \   000069   F582         MOV     DPL,A
   \   00006B   EF           MOV     A,R7
   \   00006C   3400         ADDC    A,#0x0
   \   00006E   F583         MOV     DPH,A
   \   000070   E0           MOVX    A,@DPTR
   \   000071   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq
   \   000074   F0           MOVX    @DPTR,A
    545                  ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = inMsg->srcAddr.addr.shortAddr;
   \   000075   8E82         MOV     DPL,R6
   \   000077   8F83         MOV     DPH,R7
   \   000079   A3           INC     DPTR
   \   00007A   A3           INC     DPTR
   \   00007B   E0           MOVX    A,@DPTR
   \   00007C   F8           MOV     R0,A
   \   00007D   A3           INC     DPTR
   \   00007E   E0           MOVX    A,@DPTR
   \   00007F   F9           MOV     R1,A
   \   000080   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyAddr
   \   000083   E8           MOV     A,R0
   \   000084   F0           MOVX    @DPTR,A
   \   000085   A3           INC     DPTR
   \   000086   E9           MOV     A,R1
   \   000087   F0           MOVX    @DPTR,A
    546                  
    547                  Req.scanCount--;
   \   000088   7405         MOV     A,#0x5
   \   00008A   12....       LCALL   ?XSTACK_DISP0_8
   \   00008D   E0           MOVX    A,@DPTR
   \   00008E   14           DEC     A
   \   00008F   F0           MOVX    @DPTR,A
    548                  
    549                  // Save off scan info for the subsequent scans
    550                  ZDNwkMgr_MgmtNwkUpdateReq = Req;
   \   000090   85..82       MOV     DPL,?XSP + 0
   \   000093   85..83       MOV     DPH,?XSP + 1
   \   000096   7C..         MOV     R4,#(ZDNwkMgr_MgmtNwkUpdateReq & 0xff)
   \   000098   7D..         MOV     R5,#((ZDNwkMgr_MgmtNwkUpdateReq >> 8) & 0xff)
   \   00009A   7409         MOV     A,#0x9
   \   00009C   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
   \   00009F   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    551                }
    552              }
    553            }
    554            else if ( Req.scanDuration == 0xFE )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_0:
   \   0000A2   74FE         MOV     A,#-0x2
   \   0000A4   69           XRL     A,R1
   \   0000A5   7070         JNZ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    555            {
    556              // Request is to change Channel. The command provide a new active
    557              // channel as a single channel in the channelMask.
    558              if ( Req.nwkUpdateId > _NIB.nwkUpdateId )
   \   0000A7   7406         MOV     A,#0x6
   \   0000A9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000AC   E0           MOVX    A,@DPTR
   \   0000AD   F9           MOV     R1,A
   \   0000AE   90....       MOV     DPTR,#(_NIB + 109)
   \   0000B1   E0           MOVX    A,@DPTR
   \   0000B2   C3           CLR     C
   \   0000B3   99           SUBB    A,R1
   \   0000B4   4003         JC      $+5
   \   0000B6   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    559              {
    560                uint8 i;
    561                
    562                // Set update ID in the Beacon
    563                NLME_SetUpdateID(Req.nwkUpdateId); 
   \   0000B9                ; Setup parameters for call to function NLME_SetUpdateID
   \   0000B9   12....       LCALL   ??NLME_SetUpdateID?relay
    564                
    565                // Find out the new active channel
    566                for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   0000BC   7A00         MOV     R2,#0x0
   \   0000BE   8001         SJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_3
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_4:
   \   0000C0   0A           INC     R2
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_3:
   \   0000C1   EA           MOV     A,R2
   \   0000C2   C3           CLR     C
   \   0000C3   941B         SUBB    A,#0x1b
   \   0000C5   5027         JNC     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_5
    567                {
    568                  if ( ( (uint32)1 << i ) & Req.channelMask )
   \   0000C7   75..01       MOV     ?V0 + 0,#0x1
   \   0000CA   75..00       MOV     ?V0 + 1,#0x0
   \   0000CD   75..00       MOV     ?V0 + 2,#0x0
   \   0000D0   75..00       MOV     ?V0 + 3,#0x0
   \   0000D3   EA           MOV     A,R2
   \   0000D4   78..         MOV     R0,#?V0 + 0
   \   0000D6   12....       LCALL   ?L_SHL
   \   0000D9   85..82       MOV     DPL,?XSP + 0
   \   0000DC   85..83       MOV     DPH,?XSP + 1
   \   0000DF   78..         MOV     R0,#?V0 + 0
   \   0000E1   12....       LCALL   ?L_AND_X
   \   0000E4   90....       MOV     DPTR,#__Constant_0
   \   0000E7   78..         MOV     R0,#?V0 + 0
   \   0000E9   12....       LCALL   ?L_EQ_X
   \   0000EC   60D2         JZ      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_4
    569                  {
    570                    break;
    571                  }
    572                }
    573          
    574                if ( _NIB.nwkLogicalChannel != i )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_5:
   \   0000EE   90....       MOV     DPTR,#(_NIB + 22)
   \   0000F1   E0           MOVX    A,@DPTR
   \   0000F2   6A           XRL     A,R2
   \   0000F3   7003         JNZ     $+5
   \   0000F5   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    575                {
    576                  ZDNwkMgr_NewChannel = i;
   \   0000F8   EA           MOV     A,R2
   \   0000F9   90....       MOV     DPTR,#ZDNwkMgr_NewChannel
   \   0000FC   F0           MOVX    @DPTR,A
    577                    
    578                  // Upon receipt of a Mgmt_NWK_Update_req with a change of channels, 
    579                  // the local network manager shall set a timer equal to the 
    580                  // nwkNetworkBroadcastDeliveryTime and shall switch channels upon 
    581                  // expiration of this timer.  Each node shall also increment the 
    582                  // nwkUpdateId parameter and also reset the total transmit count 
    583                  // and the transmit failure counters.  
    584                  osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_CHANNEL_CHANGE_EVT, 
    585                                      ZDNWKMGR_BCAST_DELIVERY_TIME );
   \   0000FD                ; Setup parameters for call to function osal_start_timerEx
   \   0000FD   90....       MOV     DPTR,#(_NIB + 7)
   \   000100   E0           MOVX    A,@DPTR
   \   000101   75F064       MOV     B,#0x64
   \   000104   A4           MUL     AB
   \   000105   FC           MOV     R4,A
   \   000106   ADF0         MOV     R5,B
   \   000108   7A01         MOV     R2,#0x1
   \   00010A   7B00         MOV     R3,#0x0
   \   00010C   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   00010F   E0           MOVX    A,@DPTR
   \   000110   F9           MOV     R1,A
   \   000111   12....       LCALL   ??osal_start_timerEx?relay
   \   000114   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    586                }
    587              }
    588            }
    589            else if ( Req.scanDuration == 0xFF )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2:
   \   000117   74FF         MOV     A,#-0x1
   \   000119   69           XRL     A,R1
   \   00011A   7074         JNZ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_6
    590            {
    591              // Request is to change apsChannelMask and nwkManagerAddr
    592              if ( Req.nwkUpdateId > _NIB.nwkUpdateId )
   \   00011C   7406         MOV     A,#0x6
   \   00011E   12....       LCALL   ?XSTACK_DISP0_8
   \   000121   E0           MOVX    A,@DPTR
   \   000122   F9           MOV     R1,A
   \   000123   90....       MOV     DPTR,#(_NIB + 109)
   \   000126   E0           MOVX    A,@DPTR
   \   000127   C3           CLR     C
   \   000128   99           SUBB    A,R1
   \   000129   4003         JC      $+5
   \   00012B   02....       LJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1 & 0xFFFF
    593              {
    594                NLME_SetUpdateID(Req.nwkUpdateId); // Set the updateID in the beacon
   \   00012E                ; Setup parameters for call to function NLME_SetUpdateID
   \   00012E   12....       LCALL   ??NLME_SetUpdateID?relay
    595                 
    596                if ( ( Req.channelMask != 0 ) && ( _NIB.channelList != Req.channelMask ) )
   \   000131   85..82       MOV     DPL,?XSP + 0
   \   000134   85..83       MOV     DPH,?XSP + 1
   \   000137   C082         PUSH    DPL
   \   000139   C083         PUSH    DPH
   \   00013B   90....       MOV     DPTR,#__Constant_0
   \   00013E   78..         MOV     R0,#?V0 + 0
   \   000140   12....       LCALL   ?L_MOV_X
   \   000143   D083         POP     DPH
   \   000145   D082         POP     DPL
   \   000147   78..         MOV     R0,#?V0 + 0
   \   000149   12....       LCALL   ?L_EQ_X
   \   00014C   6033         JZ      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_7
   \   00014E   90....       MOV     DPTR,#(_NIB + 36)
   \   000151   C082         PUSH    DPL
   \   000153   C083         PUSH    DPH
   \   000155   85..82       MOV     DPL,?XSP + 0
   \   000158   85..83       MOV     DPH,?XSP + 1
   \   00015B   78..         MOV     R0,#?V0 + 0
   \   00015D   12....       LCALL   ?L_MOV_X
   \   000160   D083         POP     DPH
   \   000162   D082         POP     DPL
   \   000164   78..         MOV     R0,#?V0 + 0
   \   000166   12....       LCALL   ?L_EQ_X
   \   000169   6016         JZ      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_7
    597                {
    598                  _NIB.channelList = Req.channelMask;
   \   00016B   85..82       MOV     DPL,?XSP + 0
   \   00016E   85..83       MOV     DPH,?XSP + 1
   \   000171   78..         MOV     R0,#?V0 + 0
   \   000173   12....       LCALL   ?L_MOV_X
   \   000176   90....       MOV     DPTR,#(_NIB + 36)
   \   000179   78..         MOV     R0,#?V0 + 0
   \   00017B   12....       LCALL   ?L_MOV_TO_X
    599                
    600                  // Our Channel List has been changed -- notify to save info into NV
    601                  ZDApp_NwkStateUpdateCB();
   \   00017E                ; Setup parameters for call to function ZDApp_NwkStateUpdateCB
   \   00017E   12....       LCALL   ??ZDApp_NwkStateUpdateCB?relay
    602                }
    603              
    604                ZDNwkMgr_SetNwkManagerAddr( Req.nwkManagerAddr );
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_7:
   \   000181                ; Setup parameters for call to function ZDNwkMgr_SetNwkManagerAddr
   \   000181   7407         MOV     A,#0x7
   \   000183   12....       LCALL   ?XSTACK_DISP0_8
   \   000186   E0           MOVX    A,@DPTR
   \   000187   FA           MOV     R2,A
   \   000188   A3           INC     DPTR
   \   000189   E0           MOVX    A,@DPTR
   \   00018A   FB           MOV     R3,A
   \   00018B   12....       LCALL   ??ZDNwkMgr_SetNwkManagerAddr?relay
   \   00018E   8061         SJMP    ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1
    605              }
    606            }
    607            else // 0x06-0xFD
    608            {
    609              // Request is invalid
    610              if ( !inMsg->wasBroadcast )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_6:
   \   000190   EE           MOV     A,R6
   \   000191   240B         ADD     A,#0xb
   \   000193   F582         MOV     DPL,A
   \   000195   EF           MOV     A,R7
   \   000196   3400         ADDC    A,#0x0
   \   000198   F583         MOV     DPH,A
   \   00019A   E0           MOVX    A,@DPTR
   \   00019B   7054         JNZ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1
    611              {
    612                ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = inMsg->srcAddr.addr.shortAddr;
   \   00019D   8E82         MOV     DPL,R6
   \   00019F   8F83         MOV     DPH,R7
   \   0001A1   A3           INC     DPTR
   \   0001A2   A3           INC     DPTR
   \   0001A3   E0           MOVX    A,@DPTR
   \   0001A4   F8           MOV     R0,A
   \   0001A5   A3           INC     DPTR
   \   0001A6   E0           MOVX    A,@DPTR
   \   0001A7   F9           MOV     R1,A
   \   0001A8   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyAddr
   \   0001AB   E8           MOV     A,R0
   \   0001AC   F0           MOVX    @DPTR,A
   \   0001AD   A3           INC     DPTR
   \   0001AE   E9           MOV     A,R1
   \   0001AF   F0           MOVX    @DPTR,A
    613                ZDP_MgmtNwkUpdateNotify( inMsg->TransSeq, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr,
    614                                         ZDP_INVALID_REQTYPE, 0, 0, 0, 0, NULL, AF_TX_OPTIONS_NONE, false );
   \   0001B0                ; Setup parameters for call to function ZDP_MgmtNwkUpdateNotify
   \   0001B0   75..00       MOV     ?V0 + 0,#0x0
   \   0001B3   78..         MOV     R0,#?V0 + 0
   \   0001B5   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001B8   78..         MOV     R0,#?V0 + 0
   \   0001BA   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001BD   75..00       MOV     ?V0 + 1,#0x0
   \   0001C0   78..         MOV     R0,#?V0 + 0
   \   0001C2   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001C5   78..         MOV     R0,#?V0 + 0
   \   0001C7   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001CA   78..         MOV     R0,#?V0 + 0
   \   0001CC   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001CF   90....       MOV     DPTR,#__Constant_0
   \   0001D2   12....       LCALL   ?PUSH_XSTACK8_X_FOUR
   \   0001D5   7D00         MOV     R5,#0x0
   \   0001D7   7C80         MOV     R4,#-0x80
   \   0001D9   7A..         MOV     R2,#(ZDNwkMgr_MgmtNwkUpdateNotifyAddr & 0xff)
   \   0001DB   7B..         MOV     R3,#((ZDNwkMgr_MgmtNwkUpdateNotifyAddr >> 8) & 0xff)
   \   0001DD   EE           MOV     A,R6
   \   0001DE   240F         ADD     A,#0xf
   \   0001E0   F582         MOV     DPL,A
   \   0001E2   EF           MOV     A,R7
   \   0001E3   3400         ADDC    A,#0x0
   \   0001E5   F583         MOV     DPH,A
   \   0001E7   E0           MOVX    A,@DPTR
   \   0001E8   F9           MOV     R1,A
   \   0001E9   12....       LCALL   ??ZDP_MgmtNwkUpdateNotify?relay
   \   0001EC   740C         MOV     A,#0xc
   \   0001EE   12....       LCALL   ?DEALLOC_XSTACK8
    615              }
    616            }
    617          }
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1:
   \   0001F1   7409         MOV     A,#0x9
   \   0001F3   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001F6   7F04         MOV     R7,#0x4
   \   0001F8   02....       LJMP    ?BANKED_LEAVE_XDATA
    618          
    619          /*********************************************************************
    620           * @fn      ZDNwkMgr_ProcessServerDiscRsp
    621           *
    622           * @brief   Process the incoming System Server Discovery Response
    623           *
    624           * @param   pRsp - Structure containing Server Discovery response
    625           *
    626           * @return  none
    627           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    628          void ZDNwkMgr_ProcessServerDiscRsp( zdoIncomingMsg_t *inMsg )
   \                     ZDNwkMgr_ProcessServerDiscRsp:
    629          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 3
   \   000005   74FD         MOV     A,#-0x3
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    630            ZDO_ServerDiscRsp_t Rsp;
    631            
    632            ZDO_ParseServerDiscRsp( inMsg, &Rsp );
   \   00000E                ; Setup parameters for call to function ZDO_ParseServerDiscRsp
   \   00000E   85..82       MOV     DPL,?XSP + 0
   \   000011   85..83       MOV     DPH,?XSP + 1
   \   000014   AC82         MOV     R4,DPL
   \   000016   AD83         MOV     R5,DPH
   \   000018   12....       LCALL   ??ZDO_ParseServerDiscRsp?relay
    633            
    634            if ( Rsp.status == ZSuccess )
   \   00001B   85..82       MOV     DPL,?XSP + 0
   \   00001E   85..83       MOV     DPH,?XSP + 1
   \   000021   E0           MOVX    A,@DPTR
   \   000022   7018         JNZ     ??ZDNwkMgr_ProcessServerDiscRsp_0
    635            {
    636              // Is the Network Manager bit set in the response?
    637              if ( Rsp.serverMask & NETWORK_MANAGER )
   \   000024   7401         MOV     A,#0x1
   \   000026   12....       LCALL   ?XSTACK_DISP0_8
   \   000029   E0           MOVX    A,@DPTR
   \   00002A   5440         ANL     A,#0x40
   \   00002C   600E         JZ      ??ZDNwkMgr_ProcessServerDiscRsp_0
    638              {
    639                // Set the Remote Device's NWK Address as the Network Manager Address
    640                ZDNwkMgr_SetNwkManagerAddr( inMsg->srcAddr.addr.shortAddr );
   \   00002E                ; Setup parameters for call to function ZDNwkMgr_SetNwkManagerAddr
   \   00002E   8E82         MOV     DPL,R6
   \   000030   8F83         MOV     DPH,R7
   \   000032   A3           INC     DPTR
   \   000033   A3           INC     DPTR
   \   000034   E0           MOVX    A,@DPTR
   \   000035   FA           MOV     R2,A
   \   000036   A3           INC     DPTR
   \   000037   E0           MOVX    A,@DPTR
   \   000038   FB           MOV     R3,A
   \   000039   12....       LCALL   ??ZDNwkMgr_SetNwkManagerAddr?relay
    641              }
    642            }
    643          }
   \                     ??ZDNwkMgr_ProcessServerDiscRsp_0:
   \   00003C   7403         MOV     A,#0x3
   \   00003E   12....       LCALL   ?DEALLOC_XSTACK8
   \   000041   7F01         MOV     R7,#0x1
   \   000043   02....       LJMP    ?BANKED_LEAVE_XDATA
    644          
    645          /*********************************************************************
    646           * @fn          ZDNwkMgr_ProcessChannelInterference
    647           *
    648           * @brief       This function processes the incoming Channel Interference
    649           *              detection message and sends out a notify (if needed).
    650           *
    651           * @param       pChannelInterference - interference message
    652           *
    653           * @return      none
    654           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    655          static void ZDNwkMgr_ProcessChannelInterference( ZDNwkMgr_ChanInterference_t *pChanInterference )
   \                     ZDNwkMgr_ProcessChannelInterference:
    656          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    657            // To avoid a device with communication problems from constantly 
    658            // sending reports to the network manager, the device should not 
    659            // send a Mgmt_NWK_Update_notify more than 4 times per hour.
    660            if ( ZDNwkMgr_NumUpdateNotifySent < 4 )
   \   000009   90....       MOV     DPTR,#ZDNwkMgr_NumUpdateNotifySent
   \   00000C   E0           MOVX    A,@DPTR
   \   00000D   C3           CLR     C
   \   00000E   9404         SUBB    A,#0x4
   \   000010   5049         JNC     ??ZDNwkMgr_ProcessChannelInterference_0
    661            {
    662              // Conduct an energy scan on all channels.
    663              if ( NLME_EDScanRequest( MAX_CHANNELS_24GHZ, _NIB.scanDuration ) == ZSuccess )
   \   000012                ; Setup parameters for call to function NLME_EDScanRequest
   \   000012   90....       MOV     DPTR,#(_NIB + 42)
   \   000015   E0           MOVX    A,@DPTR
   \   000016   F9           MOV     R1,A
   \   000017   90....       MOV     DPTR,#__Constant_7fff800
   \   00001A   78..         MOV     R0,#?V0 + 0
   \   00001C   12....       LCALL   ?L_MOV_X
   \   00001F   AA..         MOV     R2,?V0 + 0
   \   000021   AB..         MOV     R3,?V0 + 1
   \   000023   AC..         MOV     R4,?V0 + 2
   \   000025   AD..         MOV     R5,?V0 + 3
   \   000027   12....       LCALL   ??NLME_EDScanRequest?relay
   \   00002A   E9           MOV     A,R1
   \   00002B   702E         JNZ     ??ZDNwkMgr_ProcessChannelInterference_0
    664              {
    665                // Save the counters for the Update Notify message to be sent
    666                ZDNwkMgr_TotalTransmissions = pChanInterference->totalTransmissions;
   \   00002D   8E82         MOV     DPL,R6
   \   00002F   8F83         MOV     DPH,R7
   \   000031   A3           INC     DPTR
   \   000032   A3           INC     DPTR
   \   000033   E0           MOVX    A,@DPTR
   \   000034   F8           MOV     R0,A
   \   000035   A3           INC     DPTR
   \   000036   E0           MOVX    A,@DPTR
   \   000037   F9           MOV     R1,A
   \   000038   90....       MOV     DPTR,#ZDNwkMgr_TotalTransmissions
   \   00003B   E8           MOV     A,R0
   \   00003C   F0           MOVX    @DPTR,A
   \   00003D   A3           INC     DPTR
   \   00003E   E9           MOV     A,R1
   \   00003F   F0           MOVX    @DPTR,A
    667                ZDNwkMgr_TxFailures = pChanInterference->txFailures;
   \   000040   8E82         MOV     DPL,R6
   \   000042   8F83         MOV     DPH,R7
   \   000044   A3           INC     DPTR
   \   000045   A3           INC     DPTR
   \   000046   A3           INC     DPTR
   \   000047   A3           INC     DPTR
   \   000048   E0           MOVX    A,@DPTR
   \   000049   F8           MOV     R0,A
   \   00004A   A3           INC     DPTR
   \   00004B   E0           MOVX    A,@DPTR
   \   00004C   F9           MOV     R1,A
   \   00004D   90....       MOV     DPTR,#ZDNwkMgr_TxFailures
   \   000050   E8           MOV     A,R0
   \   000051   F0           MOVX    @DPTR,A
   \   000052   A3           INC     DPTR
   \   000053   E9           MOV     A,R1
   \   000054   F0           MOVX    @DPTR,A
    668          
    669                // Mark scan as channel inetrference check
    670                ZDNwkMgr_MgmtNwkUpdateReq.scanCount = 0xFF;
   \   000055   74FF         MOV     A,#-0x1
   \   000057   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   00005A   F0           MOVX    @DPTR,A
    671              }
    672            }
    673          }
   \                     ??ZDNwkMgr_ProcessChannelInterference_0:
   \   00005B   7F04         MOV     R7,#0x4
   \   00005D   02....       LJMP    ?BANKED_LEAVE_XDATA
    674          
    675          /*********************************************************************
    676           * @fn          ZDNwkMgr_ProcessEDScanConfirm
    677           *
    678           * @brief       This function processes the incoming ED Scan Confirm
    679           *              message and sends out a notify (if needed).
    680           *
    681           * @param       pEDScanConfirm - SD Scan Confirmation message
    682           *
    683           * @return      none
    684           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    685          static void ZDNwkMgr_ProcessEDScanConfirm( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm )
   \                     ZDNwkMgr_ProcessEDScanConfirm:
    686          { 
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 2,R2
   \   000007   8B..         MOV     ?V0 + 3,R3
    687            if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount == 0xFF )
   \   000009   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   00000C   E0           MOVX    A,@DPTR
   \   00000D   64FF         XRL     A,#0xff
   \   00000F   700A         JNZ     ??ZDNwkMgr_ProcessEDScanConfirm_0
    688            {
    689              // Confirm to scan all channels for channel interference check
    690              ZDNwkMgr_CheckForChannelInterference( pEDScanConfirm ); 
   \   000011                ; Setup parameters for call to function ZDNwkMgr_CheckForChannelInterference
   \   000011   12....       LCALL   ??ZDNwkMgr_CheckForChannelInterference?relay
    691              
    692              ZDNwkMgr_MgmtNwkUpdateReq.scanCount = 0;
   \   000014   E4           CLR     A
   \   000015   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   000018   F0           MOVX    @DPTR,A
   \   000019   804A         SJMP    ??ZDNwkMgr_ProcessEDScanConfirm_1
    693            }
    694            else
    695            {
    696              // Confirm to the requested scan
    697              uint16 txFailures = nwkTransmissionFailures( FALSE );
   \                     ??ZDNwkMgr_ProcessEDScanConfirm_0:
   \   00001B                ; Setup parameters for call to function nwkTransmissionFailures
   \   00001B   7900         MOV     R1,#0x0
   \   00001D   12....       LCALL   ??nwkTransmissionFailures?relay
   \   000020   8A..         MOV     ?V0 + 0,R2
   \   000022   8B..         MOV     ?V0 + 1,R3
    698              
    699              ZDNwkMgr_BuildAndSendUpdateNotify( ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq,
    700                                                 &ZDNwkMgr_MgmtNwkUpdateNotifyAddr, 
    701                                                 _NIB.nwkTotalTransmissions, txFailures, 
    702                                                 pEDScanConfirm, AF_TX_OPTIONS_NONE );
   \   000024                ; Setup parameters for call to function ZDNwkMgr_BuildAndSendUpdateNotify
   \   000024   75..00       MOV     ?V0 + 4,#0x0
   \   000027   78..         MOV     R0,#?V0 + 4
   \   000029   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00002C   78..         MOV     R0,#?V0 + 2
   \   00002E   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000031   78..         MOV     R0,#?V0 + 0
   \   000033   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000036   90....       MOV     DPTR,#(_NIB + 107)
   \   000039   E0           MOVX    A,@DPTR
   \   00003A   FC           MOV     R4,A
   \   00003B   A3           INC     DPTR
   \   00003C   E0           MOVX    A,@DPTR
   \   00003D   FD           MOV     R5,A
   \   00003E   7A..         MOV     R2,#(ZDNwkMgr_MgmtNwkUpdateNotifyAddr & 0xff)
   \   000040   7B..         MOV     R3,#((ZDNwkMgr_MgmtNwkUpdateNotifyAddr >> 8) & 0xff)
   \   000042   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq
   \   000045   E0           MOVX    A,@DPTR
   \   000046   F9           MOV     R1,A
   \   000047   12....       LCALL   ??ZDNwkMgr_BuildAndSendUpdateNotify?relay
   \   00004A   7405         MOV     A,#0x5
   \   00004C   12....       LCALL   ?DEALLOC_XSTACK8
    703              // More scans needed?
    704              if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount > 0 )
   \   00004F   90....       MOV     DPTR,#(ZDNwkMgr_MgmtNwkUpdateReq + 5)
   \   000052   E0           MOVX    A,@DPTR
   \   000053   6010         JZ      ??ZDNwkMgr_ProcessEDScanConfirm_1
    705              {
    706                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_SCAN_REQUEST_EVT, 50 );
   \   000055                ; Setup parameters for call to function osal_start_timerEx
   \   000055   7C32         MOV     R4,#0x32
   \   000057   7D00         MOV     R5,#0x0
   \   000059   7A08         MOV     R2,#0x8
   \   00005B   7B00         MOV     R3,#0x0
   \   00005D   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   000060   E0           MOVX    A,@DPTR
   \   000061   F9           MOV     R1,A
   \   000062   12....       LCALL   ??osal_start_timerEx?relay
    707              }
    708            }
    709          }
   \                     ??ZDNwkMgr_ProcessEDScanConfirm_1:
   \   000065   7F06         MOV     R7,#0x6
   \   000067   02....       LJMP    ?BANKED_LEAVE_XDATA
    710          
    711          /*********************************************************************
    712           * @fn          ZDNwkMgr_CheckForChannelInterference
    713           *
    714           * @brief       This function processes the incoming ED Scan Confirm
    715           *              message and sends out an Update Notify (if needed).
    716           *
    717           * @param       pEDScanConfirm - SD Scan Confirmation message
    718           *
    719           * @return      none
    720           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    721          static void ZDNwkMgr_CheckForChannelInterference( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm )
   \                     ZDNwkMgr_CheckForChannelInterference:
    722          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
    723            uint8 i;
    724            uint8 channelEnergy = 0;
   \   000005   75..00       MOV     ?V0 + 0,#0x0
    725            uint8 energyIncreased = FALSE;
   \   000008   7C00         MOV     R4,#0x0
    726              
    727            // Get the current channel energy
    728            if ( ( (uint32)1 << _NIB.nwkLogicalChannel ) & pEDScanConfirm->scannedChannels )
   \   00000A   90....       MOV     DPTR,#(_NIB + 22)
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   FD           MOV     R5,A
   \   00000F   EA           MOV     A,R2
   \   000010   2403         ADD     A,#0x3
   \   000012   FE           MOV     R6,A
   \   000013   EB           MOV     A,R3
   \   000014   3400         ADDC    A,#0x0
   \   000016   FF           MOV     R7,A
   \   000017   75..01       MOV     ?V0 + 4,#0x1
   \   00001A   8C..         MOV     ?V0 + 5,R4
   \   00001C   8C..         MOV     ?V0 + 6,R4
   \   00001E   8C..         MOV     ?V0 + 7,R4
   \   000020   ED           MOV     A,R5
   \   000021   78..         MOV     R0,#?V0 + 4
   \   000023   12....       LCALL   ?L_SHL
   \   000026   8E82         MOV     DPL,R6
   \   000028   8F83         MOV     DPH,R7
   \   00002A   78..         MOV     R0,#?V0 + 4
   \   00002C   12....       LCALL   ?L_AND_X
   \   00002F   90....       MOV     DPTR,#__Constant_0
   \   000032   78..         MOV     R0,#?V0 + 4
   \   000034   12....       LCALL   ?L_EQ_X
   \   000037   6016         JZ      ??ZDNwkMgr_CheckForChannelInterference_0
    729            {
    730              channelEnergy = pEDScanConfirm->energyDetectList[_NIB.nwkLogicalChannel];
   \   000039   8D..         MOV     ?V0 + 0,R5
   \   00003B   EA           MOV     A,R2
   \   00003C   25..         ADD     A,?V0 + 0
   \   00003E   F582         MOV     DPL,A
   \   000040   EB           MOV     A,R3
   \   000041   3400         ADDC    A,#0x0
   \   000043   F583         MOV     DPH,A
   \   000045   A3           INC     DPTR
   \   000046   A3           INC     DPTR
   \   000047   A3           INC     DPTR
   \   000048   A3           INC     DPTR
   \   000049   A3           INC     DPTR
   \   00004A   A3           INC     DPTR
   \   00004B   A3           INC     DPTR
   \   00004C   E0           MOVX    A,@DPTR
   \   00004D   F5..         MOV     ?V0 + 0,A
    731            }
    732              
    733            // If this energy scan does not indicate higher energy on the current 
    734            // channel then other channels, no action is taken. The device should 
    735            // continue to operate as normal and the message counters are not reset.
    736            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \                     ??ZDNwkMgr_CheckForChannelInterference_0:
   \   00004F   7D00         MOV     R5,#0x0
   \   000051   8001         SJMP    ??ZDNwkMgr_CheckForChannelInterference_1
   \                     ??ZDNwkMgr_CheckForChannelInterference_2:
   \   000053   0D           INC     R5
   \                     ??ZDNwkMgr_CheckForChannelInterference_1:
   \   000054   ED           MOV     A,R5
   \   000055   C3           CLR     C
   \   000056   941B         SUBB    A,#0x1b
   \   000058   503C         JNC     ??ZDNwkMgr_CheckForChannelInterference_3
    737            {
    738              if ( ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels ) && 
    739                   ( channelEnergy > pEDScanConfirm->energyDetectList[i] ) )
   \   00005A   75..01       MOV     ?V0 + 4,#0x1
   \   00005D   8C..         MOV     ?V0 + 5,R4
   \   00005F   8C..         MOV     ?V0 + 6,R4
   \   000061   8C..         MOV     ?V0 + 7,R4
   \   000063   ED           MOV     A,R5
   \   000064   78..         MOV     R0,#?V0 + 4
   \   000066   12....       LCALL   ?L_SHL
   \   000069   8E82         MOV     DPL,R6
   \   00006B   8F83         MOV     DPH,R7
   \   00006D   78..         MOV     R0,#?V0 + 4
   \   00006F   12....       LCALL   ?L_AND_X
   \   000072   90....       MOV     DPTR,#__Constant_0
   \   000075   78..         MOV     R0,#?V0 + 4
   \   000077   12....       LCALL   ?L_EQ_X
   \   00007A   60D7         JZ      ??ZDNwkMgr_CheckForChannelInterference_2
   \   00007C   8D..         MOV     ?V0 + 2,R5
   \   00007E   EA           MOV     A,R2
   \   00007F   25..         ADD     A,?V0 + 2
   \   000081   F582         MOV     DPL,A
   \   000083   EB           MOV     A,R3
   \   000084   3400         ADDC    A,#0x0
   \   000086   F583         MOV     DPH,A
   \   000088   A3           INC     DPTR
   \   000089   A3           INC     DPTR
   \   00008A   A3           INC     DPTR
   \   00008B   A3           INC     DPTR
   \   00008C   A3           INC     DPTR
   \   00008D   A3           INC     DPTR
   \   00008E   A3           INC     DPTR
   \   00008F   E0           MOVX    A,@DPTR
   \   000090   C3           CLR     C
   \   000091   95..         SUBB    A,?V0 + 0
   \   000093   50BE         JNC     ??ZDNwkMgr_CheckForChannelInterference_2
    740              {
    741                energyIncreased = TRUE;
   \   000095   0C           INC     R4
    742                break;
    743              }
    744            }
    745              
    746            // If the energy scan does indicate increased energy on the channel
    747            // in use, a Mgmt_NWK_Update_notify should be sent to the Network 
    748            // Manager to indicate interference is present.
    749            if ( energyIncreased )
   \                     ??ZDNwkMgr_CheckForChannelInterference_3:
   \   000096   EC           MOV     A,R4
   \   000097   6069         JZ      ??ZDNwkMgr_CheckForChannelInterference_4
    750            {
    751              // Send a Management Network Update notify to the Network Manager
    752              ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = _NIB.nwkManagerAddr;
   \   000099   90....       MOV     DPTR,#(_NIB + 105)
   \   00009C   E0           MOVX    A,@DPTR
   \   00009D   F8           MOV     R0,A
   \   00009E   A3           INC     DPTR
   \   00009F   E0           MOVX    A,@DPTR
   \   0000A0   F9           MOV     R1,A
   \   0000A1   90....       MOV     DPTR,#ZDNwkMgr_MgmtNwkUpdateNotifyAddr
   \   0000A4   E8           MOV     A,R0
   \   0000A5   F0           MOVX    @DPTR,A
   \   0000A6   A3           INC     DPTR
   \   0000A7   E9           MOV     A,R1
   \   0000A8   F0           MOVX    @DPTR,A
    753              ZDNwkMgr_BuildAndSendUpdateNotify( 0, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr, 
    754                                                 ZDNwkMgr_TotalTransmissions, ZDNwkMgr_TxFailures,
    755                                                 pEDScanConfirm, AF_MSG_ACK_REQUEST );
   \   0000A9                ; Setup parameters for call to function ZDNwkMgr_BuildAndSendUpdateNotify
   \   0000A9   75..10       MOV     ?V0 + 0,#0x10
   \   0000AC   78..         MOV     R0,#?V0 + 0
   \   0000AE   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000B1   8A..         MOV     ?V0 + 0,R2
   \   0000B3   8B..         MOV     ?V0 + 1,R3
   \   0000B5   78..         MOV     R0,#?V0 + 0
   \   0000B7   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000BA   90....       MOV     DPTR,#ZDNwkMgr_TxFailures
   \   0000BD   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   0000C0   90....       MOV     DPTR,#ZDNwkMgr_TotalTransmissions
   \   0000C3   E0           MOVX    A,@DPTR
   \   0000C4   FC           MOV     R4,A
   \   0000C5   A3           INC     DPTR
   \   0000C6   E0           MOVX    A,@DPTR
   \   0000C7   FD           MOV     R5,A
   \   0000C8   7A..         MOV     R2,#(ZDNwkMgr_MgmtNwkUpdateNotifyAddr & 0xff)
   \   0000CA   7B..         MOV     R3,#((ZDNwkMgr_MgmtNwkUpdateNotifyAddr >> 8) & 0xff)
   \   0000CC   7900         MOV     R1,#0x0
   \   0000CE   12....       LCALL   ??ZDNwkMgr_BuildAndSendUpdateNotify?relay
   \   0000D1   7405         MOV     A,#0x5
   \   0000D3   12....       LCALL   ?DEALLOC_XSTACK8
    756              ZDNwkMgr_WaitingForNotifyConfirm = TRUE; // Confirm will clear the counters
   \   0000D6   7401         MOV     A,#0x1
   \   0000D8   90....       MOV     DPTR,#ZDNwkMgr_WaitingForNotifyConfirm
   \   0000DB   F0           MOVX    @DPTR,A
    757                
    758              if ( ZDNwkMgr_NumUpdateNotifySent == 0 )
   \   0000DC   90....       MOV     DPTR,#ZDNwkMgr_NumUpdateNotifySent
   \   0000DF   E0           MOVX    A,@DPTR
   \   0000E0   7018         JNZ     ??ZDNwkMgr_CheckForChannelInterference_5
    759              {
    760                // First notify message sent within this hour. Start the Update Notify timer.
    761                ZDNwkMgr_UpdateNotifyTimer = ZDNWKMGR_UPDATE_NOTIFY_TIMER;
   \   0000E2   90....       MOV     DPTR,#ZDNwkMgr_UpdateNotifyTimer
   \   0000E5   743C         MOV     A,#0x3c
   \   0000E7   F0           MOVX    @DPTR,A
   \   0000E8   A3           INC     DPTR
   \   0000E9   E4           CLR     A
   \   0000EA   F0           MOVX    @DPTR,A
    762                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_NOTIFY_EVT, ONE_MINUTE );
   \   0000EB                ; Setup parameters for call to function osal_start_timerEx
   \   0000EB   7C60         MOV     R4,#0x60
   \   0000ED   7DEA         MOV     R5,#-0x16
   \   0000EF   7A02         MOV     R2,#0x2
   \   0000F1   FB           MOV     R3,A
   \   0000F2   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   0000F5   E0           MOVX    A,@DPTR
   \   0000F6   F9           MOV     R1,A
   \   0000F7   12....       LCALL   ??osal_start_timerEx?relay
    763              }
    764              
    765              ZDNwkMgr_NumUpdateNotifySent++;
   \                     ??ZDNwkMgr_CheckForChannelInterference_5:
   \   0000FA   90....       MOV     DPTR,#ZDNwkMgr_NumUpdateNotifySent
   \   0000FD   E0           MOVX    A,@DPTR
   \   0000FE   04           INC     A
   \   0000FF   F0           MOVX    @DPTR,A
   \   000100   8036         SJMP    ??ZDNwkMgr_CheckForChannelInterference_6
    766            }
    767          #if defined ( LCD_SUPPORTED )
    768            else
    769            {
    770              HalLcdWriteString( (char*)NwkMgrStr_4, HAL_LCD_LINE_1 );
   \                     ??ZDNwkMgr_CheckForChannelInterference_4:
   \   000102                ; Setup parameters for call to function HalLcdWriteString
   \   000102   7901         MOV     R1,#0x1
   \   000104   7A..         MOV     R2,#(NwkMgrStr_4 & 0xff)
   \   000106   7B..         MOV     R3,#((NwkMgrStr_4 >> 8) & 0xff)
   \   000108   12....       LCALL   ??HalLcdWriteString?relay
    771              HalLcdWriteStringValueValue( ": ", _NIB.nwkLogicalChannel, 10, channelEnergy, 10, HAL_LCD_LINE_2 );
   \   00010B                ; Setup parameters for call to function HalLcdWriteStringValueValue
   \   00010B   75..02       MOV     ?V0 + 1,#0x2
   \   00010E   78..         MOV     R0,#?V0 + 1
   \   000110   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000113   75..0A       MOV     ?V0 + 1,#0xa
   \   000116   78..         MOV     R0,#?V0 + 1
   \   000118   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00011B   75..00       MOV     ?V0 + 1,#0x0
   \   00011E   78..         MOV     R0,#?V0 + 0
   \   000120   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000123   790A         MOV     R1,#0xa
   \   000125   90....       MOV     DPTR,#(_NIB + 22)
   \   000128   E0           MOVX    A,@DPTR
   \   000129   FC           MOV     R4,A
   \   00012A   7D00         MOV     R5,#0x0
   \   00012C   7A..         MOV     R2,#(`?<Constant ": ">` & 0xff)
   \   00012E   7B..         MOV     R3,#((`?<Constant ": ">` >> 8) & 0xff)
   \   000130   12....       LCALL   ??HalLcdWriteStringValueValue?relay
   \   000133   7404         MOV     A,#0x4
   \   000135   12....       LCALL   ?DEALLOC_XSTACK8
    772            }
    773          #endif
    774          }
   \                     ??ZDNwkMgr_CheckForChannelInterference_6:
   \   000138   7F08         MOV     R7,#0x8
   \   00013A   02....       LJMP    ?BANKED_LEAVE_XDATA
    775          
    776          /*********************************************************************
    777           * @fn          ZDNwkMgr_BuildAndSendUpdateNotify
    778           *
    779           * @brief       This builds and send a Mgmt_NWK_Update_notify message. This
    780           *              function sends a unicast message.
    781           *
    782           * @param       TransSeq - transaction sequence number
    783           * @param       dstAddr - destination address of the message
    784           * @param       pEDScanConfirm - update notify info
    785           *
    786           * @return      afStatus_t
    787           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    788          static void ZDNwkMgr_BuildAndSendUpdateNotify( uint8 TransSeq, zAddrType_t *dstAddr,
   \                     ZDNwkMgr_BuildAndSendUpdateNotify:
    789                                                         uint16 totalTransmissions, uint16 txFailures,
    790                                                         ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm,
    791                                                         uint8 txOptions )
    792          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 4
   \   000005   74FC         MOV     A,#-0x4
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   7402         MOV     A,#0x2
   \   00000C   12....       LCALL   ?XSTACK_DISP0_8
   \   00000F   EA           MOV     A,R2
   \   000010   F0           MOVX    @DPTR,A
   \   000011   A3           INC     DPTR
   \   000012   EB           MOV     A,R3
   \   000013   F0           MOVX    @DPTR,A
   \   000014   89..         MOV     ?V0 + 7,R1
   \   000016   8C..         MOV     ?V0 + 4,R4
   \   000018   8D..         MOV     ?V0 + 5,R5
   \   00001A   7414         MOV     A,#0x14
   \   00001C   12....       LCALL   ?XSTACK_DISP0_8
   \   00001F   E0           MOVX    A,@DPTR
   \   000020   FE           MOV     R6,A
   \   000021   A3           INC     DPTR
   \   000022   E0           MOVX    A,@DPTR
   \   000023   FF           MOV     R7,A
    793            uint8 i;
    794            uint8 listCount = 0;
   \   000024   75..00       MOV     ?V0 + 6,#0x0
    795            uint8 *energyValues = NULL;
   \   000027   85..82       MOV     DPL,?XSP + 0
   \   00002A   85..83       MOV     DPH,?XSP + 1
   \   00002D   E4           CLR     A
   \   00002E   F0           MOVX    @DPTR,A
   \   00002F   A3           INC     DPTR
   \   000030   F0           MOVX    @DPTR,A
    796            
    797            // Count number of energy detects
    798            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   000031   FA           MOV     R2,A
   \   000032   8034         SJMP    ??ZDNwkMgr_BuildAndSendUpdateNotify_0
    799            {
    800              if ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels )
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_1:
   \   000034   75..01       MOV     ?V0 + 0,#0x1
   \   000037   75..00       MOV     ?V0 + 1,#0x0
   \   00003A   75..00       MOV     ?V0 + 2,#0x0
   \   00003D   75..00       MOV     ?V0 + 3,#0x0
   \   000040   EA           MOV     A,R2
   \   000041   78..         MOV     R0,#?V0 + 0
   \   000043   12....       LCALL   ?L_SHL
   \   000046   7416         MOV     A,#0x16
   \   000048   12....       LCALL   ?XSTACK_DISP0_8
   \   00004B   E0           MOVX    A,@DPTR
   \   00004C   F8           MOV     R0,A
   \   00004D   A3           INC     DPTR
   \   00004E   E0           MOVX    A,@DPTR
   \   00004F   F583         MOV     DPH,A
   \   000051   8882         MOV     DPL,R0
   \   000053   A3           INC     DPTR
   \   000054   A3           INC     DPTR
   \   000055   A3           INC     DPTR
   \   000056   78..         MOV     R0,#?V0 + 0
   \   000058   12....       LCALL   ?L_AND_X
   \   00005B   90....       MOV     DPTR,#__Constant_0
   \   00005E   78..         MOV     R0,#?V0 + 0
   \   000060   12....       LCALL   ?L_EQ_X
   \   000063   6002         JZ      ??ZDNwkMgr_BuildAndSendUpdateNotify_2
    801                listCount++;
   \   000065   05..         INC     ?V0 + 6
    802            }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_2:
   \   000067   0A           INC     R2
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_0:
   \   000068   EA           MOV     A,R2
   \   000069   C3           CLR     C
   \   00006A   941B         SUBB    A,#0x1b
   \   00006C   40C6         JC      ??ZDNwkMgr_BuildAndSendUpdateNotify_1
    803            
    804            if ( listCount > 0 )
   \   00006E   E5..         MOV     A,?V0 + 6
   \   000070   7003         JNZ     $+5
   \   000072   02....       LJMP    ??ZDNwkMgr_BuildAndSendUpdateNotify_3 & 0xFFFF
    805            {
    806              energyValues = (uint8 *)osal_mem_alloc( listCount );
   \   000075                ; Setup parameters for call to function osal_mem_alloc
   \   000075   FA           MOV     R2,A
   \   000076   7B00         MOV     R3,#0x0
   \   000078   12....       LCALL   ??osal_mem_alloc?relay
   \   00007B   85..82       MOV     DPL,?XSP + 0
   \   00007E   85..83       MOV     DPH,?XSP + 1
   \   000081   EA           MOV     A,R2
   \   000082   F0           MOVX    @DPTR,A
   \   000083   A3           INC     DPTR
   \   000084   EB           MOV     A,R3
   \   000085   F0           MOVX    @DPTR,A
    807              if ( energyValues )
   \   000086   85..82       MOV     DPL,?XSP + 0
   \   000089   85..83       MOV     DPH,?XSP + 1
   \   00008C   E0           MOVX    A,@DPTR
   \   00008D   7002         JNZ     ??ZDNwkMgr_BuildAndSendUpdateNotify_4
   \   00008F   A3           INC     DPTR
   \   000090   E0           MOVX    A,@DPTR
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_4:
   \   000091   6071         JZ      ??ZDNwkMgr_BuildAndSendUpdateNotify_3
    808              {
    809                uint8 j = 0;
   \   000093   7B00         MOV     R3,#0x0
    810          
    811                for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   000095   7A00         MOV     R2,#0x0
   \   000097   8065         SJMP    ??ZDNwkMgr_BuildAndSendUpdateNotify_5
    812                {
    813                  if ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels )
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_6:
   \   000099   75..01       MOV     ?V0 + 0,#0x1
   \   00009C   75..00       MOV     ?V0 + 1,#0x0
   \   00009F   75..00       MOV     ?V0 + 2,#0x0
   \   0000A2   75..00       MOV     ?V0 + 3,#0x0
   \   0000A5   EA           MOV     A,R2
   \   0000A6   78..         MOV     R0,#?V0 + 0
   \   0000A8   12....       LCALL   ?L_SHL
   \   0000AB   7416         MOV     A,#0x16
   \   0000AD   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B0   E0           MOVX    A,@DPTR
   \   0000B1   F8           MOV     R0,A
   \   0000B2   A3           INC     DPTR
   \   0000B3   E0           MOVX    A,@DPTR
   \   0000B4   F583         MOV     DPH,A
   \   0000B6   8882         MOV     DPL,R0
   \   0000B8   A3           INC     DPTR
   \   0000B9   A3           INC     DPTR
   \   0000BA   A3           INC     DPTR
   \   0000BB   78..         MOV     R0,#?V0 + 0
   \   0000BD   12....       LCALL   ?L_AND_X
   \   0000C0   90....       MOV     DPTR,#__Constant_0
   \   0000C3   78..         MOV     R0,#?V0 + 0
   \   0000C5   12....       LCALL   ?L_EQ_X
   \   0000C8   6033         JZ      ??ZDNwkMgr_BuildAndSendUpdateNotify_7
    814                    energyValues[j++] = pEDScanConfirm->energyDetectList[i];
   \   0000CA   EA           MOV     A,R2
   \   0000CB   F8           MOV     R0,A
   \   0000CC   7416         MOV     A,#0x16
   \   0000CE   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D1   E0           MOVX    A,@DPTR
   \   0000D2   28           ADD     A,R0
   \   0000D3   FC           MOV     R4,A
   \   0000D4   A3           INC     DPTR
   \   0000D5   E0           MOVX    A,@DPTR
   \   0000D6   3400         ADDC    A,#0x0
   \   0000D8   8C82         MOV     DPL,R4
   \   0000DA   F583         MOV     DPH,A
   \   0000DC   A3           INC     DPTR
   \   0000DD   A3           INC     DPTR
   \   0000DE   A3           INC     DPTR
   \   0000DF   A3           INC     DPTR
   \   0000E0   A3           INC     DPTR
   \   0000E1   A3           INC     DPTR
   \   0000E2   A3           INC     DPTR
   \   0000E3   E0           MOVX    A,@DPTR
   \   0000E4   C0E0         PUSH    A
   \   0000E6   EB           MOV     A,R3
   \   0000E7   F8           MOV     R0,A
   \   0000E8   85..82       MOV     DPL,?XSP + 0
   \   0000EB   85..83       MOV     DPH,?XSP + 1
   \   0000EE   E0           MOVX    A,@DPTR
   \   0000EF   28           ADD     A,R0
   \   0000F0   FC           MOV     R4,A
   \   0000F1   A3           INC     DPTR
   \   0000F2   E0           MOVX    A,@DPTR
   \   0000F3   3400         ADDC    A,#0x0
   \   0000F5   8C82         MOV     DPL,R4
   \   0000F7   F583         MOV     DPH,A
   \   0000F9   D0E0         POP     A
   \   0000FB   F0           MOVX    @DPTR,A
   \   0000FC   0B           INC     R3
    815                }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_7:
   \   0000FD   0A           INC     R2
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_5:
   \   0000FE   EA           MOV     A,R2
   \   0000FF   C3           CLR     C
   \   000100   941B         SUBB    A,#0x1b
   \   000102   4095         JC      ??ZDNwkMgr_BuildAndSendUpdateNotify_6
    816              }
    817            }
    818              
    819            // Send a Management Network Update notify back
    820            ZDP_MgmtNwkUpdateNotify( TransSeq, dstAddr, pEDScanConfirm->status, 
    821                                     pEDScanConfirm->scannedChannels,
    822                                     totalTransmissions, txFailures,
    823                                     listCount, energyValues, txOptions, false );
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_3:
   \   000104                ; Setup parameters for call to function ZDP_MgmtNwkUpdateNotify
   \   000104   75..00       MOV     ?V0 + 0,#0x0
   \   000107   78..         MOV     R0,#?V0 + 0
   \   000109   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00010C   7419         MOV     A,#0x19
   \   00010E   12....       LCALL   ?XSTACK_DISP0_8
   \   000111   E0           MOVX    A,@DPTR
   \   000112   F5..         MOV     ?V0 + 0,A
   \   000114   78..         MOV     R0,#?V0 + 0
   \   000116   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000119   7402         MOV     A,#0x2
   \   00011B   12....       LCALL   ?XSTACK_DISP0_8
   \   00011E   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000121   8E..         MOV     ?V0 + 0,R6
   \   000123   8F..         MOV     ?V0 + 1,R7
   \   000125   78..         MOV     R0,#?V0 + 0
   \   000127   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00012A   78..         MOV     R0,#?V0 + 4
   \   00012C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00012F   741E         MOV     A,#0x1e
   \   000131   12....       LCALL   ?XSTACK_DISP0_8
   \   000134   E0           MOVX    A,@DPTR
   \   000135   F8           MOV     R0,A
   \   000136   A3           INC     DPTR
   \   000137   E0           MOVX    A,@DPTR
   \   000138   F583         MOV     DPH,A
   \   00013A   8882         MOV     DPL,R0
   \   00013C   A3           INC     DPTR
   \   00013D   A3           INC     DPTR
   \   00013E   A3           INC     DPTR
   \   00013F   12....       LCALL   ?PUSH_XSTACK8_X_FOUR
   \   000142   AD..         MOV     R5,?V0 + 6
   \   000144   7422         MOV     A,#0x22
   \   000146   12....       LCALL   ?XSTACK_DISP0_8
   \   000149   E0           MOVX    A,@DPTR
   \   00014A   F8           MOV     R0,A
   \   00014B   A3           INC     DPTR
   \   00014C   E0           MOVX    A,@DPTR
   \   00014D   F583         MOV     DPH,A
   \   00014F   8882         MOV     DPL,R0
   \   000151   A3           INC     DPTR
   \   000152   A3           INC     DPTR
   \   000153   E0           MOVX    A,@DPTR
   \   000154   FC           MOV     R4,A
   \   000155   740E         MOV     A,#0xe
   \   000157   12....       LCALL   ?XSTACK_DISP0_8
   \   00015A   E0           MOVX    A,@DPTR
   \   00015B   FA           MOV     R2,A
   \   00015C   A3           INC     DPTR
   \   00015D   E0           MOVX    A,@DPTR
   \   00015E   FB           MOV     R3,A
   \   00015F   A9..         MOV     R1,?V0 + 7
   \   000161   12....       LCALL   ??ZDP_MgmtNwkUpdateNotify?relay
   \   000164   740C         MOV     A,#0xc
   \   000166   12....       LCALL   ?DEALLOC_XSTACK8
    824            if ( energyValues )
   \   000169   85..82       MOV     DPL,?XSP + 0
   \   00016C   85..83       MOV     DPH,?XSP + 1
   \   00016F   E0           MOVX    A,@DPTR
   \   000170   7002         JNZ     ??ZDNwkMgr_BuildAndSendUpdateNotify_8
   \   000172   A3           INC     DPTR
   \   000173   E0           MOVX    A,@DPTR
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_8:
   \   000174   600E         JZ      ??ZDNwkMgr_BuildAndSendUpdateNotify_9
    825              osal_mem_free( energyValues );
   \   000176                ; Setup parameters for call to function osal_mem_free
   \   000176   85..82       MOV     DPL,?XSP + 0
   \   000179   85..83       MOV     DPH,?XSP + 1
   \   00017C   E0           MOVX    A,@DPTR
   \   00017D   FA           MOV     R2,A
   \   00017E   A3           INC     DPTR
   \   00017F   E0           MOVX    A,@DPTR
   \   000180   FB           MOV     R3,A
   \   000181   12....       LCALL   ??osal_mem_free?relay
    826          }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_9:
   \   000184   7404         MOV     A,#0x4
   \   000186   12....       LCALL   ?DEALLOC_XSTACK8
   \   000189   7F08         MOV     R7,#0x8
   \   00018B   02....       LJMP    ?BANKED_LEAVE_XDATA
    827          
    828          #if defined ( NWK_MANAGER )
    829          /*********************************************************************
    830           * @fn      NwkMgr_SetNwkManager
    831           *
    832           * @brief   Set the local device as the Network Manager
    833           *
    834           * @param   none
    835           *
    836           * @return  none
    837           */
    838          void NwkMgr_SetNwkManager( void )
    839          {
    840            if ( zgNwkMgrMode == ZDNWKMGR_ENABLE )
    841            {
    842              // We're the Network Manager. Set our address as the Network Manager Address
    843              ZDNwkMgr_SetNwkManagerAddr( _NIB.nwkDevAddress );
    844              
    845              // Set the Network Manager bit of the Server Mask
    846              ZDO_Config_Node_Descriptor.ServerMask |= NETWORK_MANAGER;
    847            }
    848          }
    849          #endif // NWK_MANAGER
    850          
    851          /*********************************************************************
    852           * @fn      ZDApp_SetNwkManagerAddr()
    853           *
    854           * @brief   Sets the nwkManagerAddr in NIB.
    855           *
    856           * @param   nwkManagerAddr
    857           *
    858           * @return  none
    859           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    860          void ZDNwkMgr_SetNwkManagerAddr( uint16 nwkManagerAddr )
   \                     ZDNwkMgr_SetNwkManagerAddr:
    861          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    862            if ( _NIB.nwkManagerAddr != nwkManagerAddr )
   \   000004   90....       MOV     DPTR,#(_NIB + 105)
   \   000007   E0           MOVX    A,@DPTR
   \   000008   6A           XRL     A,R2
   \   000009   7003         JNZ     ??ZDNwkMgr_SetNwkManagerAddr_0
   \   00000B   A3           INC     DPTR
   \   00000C   E0           MOVX    A,@DPTR
   \   00000D   6B           XRL     A,R3
   \                     ??ZDNwkMgr_SetNwkManagerAddr_0:
   \   00000E   600B         JZ      ??ZDNwkMgr_SetNwkManagerAddr_1
    863            {
    864              // Update the Network Manager Address
    865              _NIB.nwkManagerAddr = nwkManagerAddr;
   \   000010   90....       MOV     DPTR,#(_NIB + 105)
   \   000013   EA           MOV     A,R2
   \   000014   F0           MOVX    @DPTR,A
   \   000015   A3           INC     DPTR
   \   000016   EB           MOV     A,R3
   \   000017   F0           MOVX    @DPTR,A
    866            
    867              // Our Network Manger Address has been changed -- notify to save info into NV
    868              ZDApp_NwkStateUpdateCB();
   \   000018                ; Setup parameters for call to function ZDApp_NwkStateUpdateCB
   \   000018   12....       LCALL   ??ZDApp_NwkStateUpdateCB?relay
    869            }
    870          }
   \                     ??ZDNwkMgr_SetNwkManagerAddr_1:
   \   00001B   D083         POP     DPH
   \   00001D   D082         POP     DPL
   \   00001F   02....       LJMP    ?BRET
    871          
    872          /*********************************************************************
    873           * @fn          ZDNwkMgr_ReportChannelInterference
    874           *
    875           * @brief       This function builds a Channel Interference detection
    876           *              message and then forwards it to the Network Manager.
    877           *
    878           * @param       chanInterference
    879           *
    880           * @return      none
    881           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    882          void ZDNwkMgr_ReportChannelInterference(  NLME_ChanInterference_t *chanInterference  )
   \                     ZDNwkMgr_ReportChannelInterference:
    883          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    884            ZDNwkMgr_ChanInterference_t *pChanInterference;
    885          
    886            // Send Channel Interference message to the Network Manager task
    887            pChanInterference = (ZDNwkMgr_ChanInterference_t *)osal_msg_allocate( sizeof( ZDNwkMgr_ChanInterference_t ) );
   \   000009                ; Setup parameters for call to function osal_msg_allocate
   \   000009   7A06         MOV     R2,#0x6
   \   00000B   7B00         MOV     R3,#0x0
   \   00000D   12....       LCALL   ??osal_msg_allocate?relay
    888            if ( pChanInterference )
   \   000010   EA           MOV     A,R2
   \   000011   7001         JNZ     ??ZDNwkMgr_ReportChannelInterference_0
   \   000013   EB           MOV     A,R3
   \                     ??ZDNwkMgr_ReportChannelInterference_0:
   \   000014   603B         JZ      ??ZDNwkMgr_ReportChannelInterference_1
    889            {
    890              pChanInterference->hdr.event = NM_CHANNEL_INTERFERE;
   \   000016   7431         MOV     A,#0x31
   \   000018   8A82         MOV     DPL,R2
   \   00001A   8B83         MOV     DPH,R3
   \   00001C   F0           MOVX    @DPTR,A
    891                
    892              // Build the structure
    893              pChanInterference->totalTransmissions = chanInterference->totalTransmissions;
   \   00001D   8E82         MOV     DPL,R6
   \   00001F   8F83         MOV     DPH,R7
   \   000021   E0           MOVX    A,@DPTR
   \   000022   F8           MOV     R0,A
   \   000023   A3           INC     DPTR
   \   000024   E0           MOVX    A,@DPTR
   \   000025   F9           MOV     R1,A
   \   000026   8A82         MOV     DPL,R2
   \   000028   8B83         MOV     DPH,R3
   \   00002A   A3           INC     DPTR
   \   00002B   A3           INC     DPTR
   \   00002C   E8           MOV     A,R0
   \   00002D   F0           MOVX    @DPTR,A
   \   00002E   A3           INC     DPTR
   \   00002F   E9           MOV     A,R1
   \   000030   F0           MOVX    @DPTR,A
    894              pChanInterference->txFailures = chanInterference->txFailures;
   \   000031   8E82         MOV     DPL,R6
   \   000033   8F83         MOV     DPH,R7
   \   000035   A3           INC     DPTR
   \   000036   A3           INC     DPTR
   \   000037   E0           MOVX    A,@DPTR
   \   000038   F8           MOV     R0,A
   \   000039   A3           INC     DPTR
   \   00003A   E0           MOVX    A,@DPTR
   \   00003B   F9           MOV     R1,A
   \   00003C   8A82         MOV     DPL,R2
   \   00003E   8B83         MOV     DPH,R3
   \   000040   A3           INC     DPTR
   \   000041   A3           INC     DPTR
   \   000042   A3           INC     DPTR
   \   000043   A3           INC     DPTR
   \   000044   E8           MOV     A,R0
   \   000045   F0           MOVX    @DPTR,A
   \   000046   A3           INC     DPTR
   \   000047   E9           MOV     A,R1
   \   000048   F0           MOVX    @DPTR,A
    895                        
    896              osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pChanInterference );
   \   000049                ; Setup parameters for call to function osal_msg_send
   \   000049   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   00004C   E0           MOVX    A,@DPTR
   \   00004D   F9           MOV     R1,A
   \   00004E   12....       LCALL   ??osal_msg_send?relay
    897            }
    898          }
   \                     ??ZDNwkMgr_ReportChannelInterference_1:
   \   000051   7F02         MOV     R7,#0x2
   \   000053   02....       LJMP    ?BANKED_LEAVE_XDATA
    899          
    900          /*********************************************************************
    901           * @fn          ZDNwkMgr_EDScanConfirmCB
    902           *
    903           * @brief       Handle Energy Scan confirm callback
    904           *
    905           * @param       scannedChannels  - scanned channels
    906           * @param       energyDetectList - measured energy for channels
    907           *
    908           * @return      none
    909           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    910          void ZDNwkMgr_EDScanConfirmCB( NLME_EDScanConfirm_t *EDScanConfirm )
   \                     ZDNwkMgr_EDScanConfirmCB:
    911          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 4,R2
   \   000007   8B..         MOV     ?V0 + 5,R3
    912            ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm;
    913          
    914            // Send ED Confirm to the Network Manager task
    915            pEDScanConfirm = (ZDNwkMgr_EDScanConfirm_t *)osal_msg_allocate( sizeof( ZDNwkMgr_EDScanConfirm_t ) );
   \   000009                ; Setup parameters for call to function osal_msg_allocate
   \   000009   7A22         MOV     R2,#0x22
   \   00000B   7B00         MOV     R3,#0x0
   \   00000D   12....       LCALL   ??osal_msg_allocate?relay
   \   000010   8A..         MOV     ?V0 + 0,R2
   \   000012   8B..         MOV     ?V0 + 1,R3
   \   000014   AE..         MOV     R6,?V0 + 0
   \   000016   AF..         MOV     R7,?V0 + 1
    916            if ( pEDScanConfirm )
   \   000018   EE           MOV     A,R6
   \   000019   7001         JNZ     ??ZDNwkMgr_EDScanConfirmCB_0
   \   00001B   EF           MOV     A,R7
   \                     ??ZDNwkMgr_EDScanConfirmCB_0:
   \   00001C   6071         JZ      ??ZDNwkMgr_EDScanConfirmCB_1
    917            {
    918              pEDScanConfirm->hdr.event = NM_ED_SCAN_CONFIRM;
   \   00001E   7432         MOV     A,#0x32
   \   000020   8E82         MOV     DPL,R6
   \   000022   8F83         MOV     DPH,R7
   \   000024   F0           MOVX    @DPTR,A
    919                
    920              // Build the structure
    921              pEDScanConfirm->status = EDScanConfirm->status;
   \   000025   85..82       MOV     DPL,?V0 + 4
   \   000028   85..83       MOV     DPH,?V0 + 5
   \   00002B   E0           MOVX    A,@DPTR
   \   00002C   8E82         MOV     DPL,R6
   \   00002E   8F83         MOV     DPH,R7
   \   000030   A3           INC     DPTR
   \   000031   A3           INC     DPTR
   \   000032   F0           MOVX    @DPTR,A
    922              pEDScanConfirm->scannedChannels = EDScanConfirm->scannedChannels;
   \   000033   85..82       MOV     DPL,?V0 + 4
   \   000036   85..83       MOV     DPH,?V0 + 5
   \   000039   A3           INC     DPTR
   \   00003A   78..         MOV     R0,#?V0 + 0
   \   00003C   12....       LCALL   ?L_MOV_X
   \   00003F   8E82         MOV     DPL,R6
   \   000041   8F83         MOV     DPH,R7
   \   000043   A3           INC     DPTR
   \   000044   A3           INC     DPTR
   \   000045   A3           INC     DPTR
   \   000046   E5..         MOV     A,?V0 + 0
   \   000048   F0           MOVX    @DPTR,A
   \   000049   A3           INC     DPTR
   \   00004A   E5..         MOV     A,?V0 + 1
   \   00004C   F0           MOVX    @DPTR,A
   \   00004D   A3           INC     DPTR
   \   00004E   E5..         MOV     A,?V0 + 2
   \   000050   F0           MOVX    @DPTR,A
   \   000051   A3           INC     DPTR
   \   000052   E5..         MOV     A,?V0 + 3
   \   000054   F0           MOVX    @DPTR,A
    923              osal_memcpy( pEDScanConfirm->energyDetectList, EDScanConfirm->energyDetectList, ED_SCAN_MAXCHANNELS );
   \   000055                ; Setup parameters for call to function osal_memcpy
   \   000055   85..82       MOV     DPL,?V0 + 4
   \   000058   85..83       MOV     DPH,?V0 + 5
   \   00005B   A3           INC     DPTR
   \   00005C   A3           INC     DPTR
   \   00005D   A3           INC     DPTR
   \   00005E   A3           INC     DPTR
   \   00005F   A3           INC     DPTR
   \   000060   E0           MOVX    A,@DPTR
   \   000061   F5..         MOV     ?V0 + 0,A
   \   000063   A3           INC     DPTR
   \   000064   E0           MOVX    A,@DPTR
   \   000065   F5..         MOV     ?V0 + 1,A
   \   000067   75..00       MOV     ?V0 + 2,#0x0
   \   00006A   78..         MOV     R0,#?V0 + 0
   \   00006C   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   00006F   7C1B         MOV     R4,#0x1b
   \   000071   7D00         MOV     R5,#0x0
   \   000073   EE           MOV     A,R6
   \   000074   2407         ADD     A,#0x7
   \   000076   FA           MOV     R2,A
   \   000077   EF           MOV     A,R7
   \   000078   3400         ADDC    A,#0x0
   \   00007A   FB           MOV     R3,A
   \   00007B   12....       LCALL   ??osal_memcpy?relay
   \   00007E   7403         MOV     A,#0x3
   \   000080   12....       LCALL   ?DEALLOC_XSTACK8
    924                
    925              osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pEDScanConfirm );
   \   000083                ; Setup parameters for call to function osal_msg_send
   \   000083   EE           MOV     A,R6
   \   000084   FA           MOV     R2,A
   \   000085   EF           MOV     A,R7
   \   000086   FB           MOV     R3,A
   \   000087   90....       MOV     DPTR,#ZDNwkMgr_TaskID
   \   00008A   E0           MOVX    A,@DPTR
   \   00008B   F9           MOV     R1,A
   \   00008C   12....       LCALL   ??osal_msg_send?relay
    926            }
    927          }
   \                     ??ZDNwkMgr_EDScanConfirmCB_1:
   \   00008F   7F06         MOV     R7,#0x6
   \   000091   02....       LJMP    ?BANKED_LEAVE_XDATA
    928          
    929          /*********************************************************************
    930           * @fn      ZDNwkMgr_ProcessDataConfirm
    931           *
    932           * @brief   Process received Confirmation for Mgmt NWK Update Notify message
    933           *
    934           * @param   none
    935           *
    936           * @return  none
    937           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    938          void ZDNwkMgr_ProcessDataConfirm( afDataConfirm_t *afDataConfirm )
   \                     ZDNwkMgr_ProcessDataConfirm:
    939          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    940            if (   ZDNwkMgr_WaitingForNotifyConfirm  && 
    941                 ( afDataConfirm->transID == 0 )     && 
    942                 ( afDataConfirm->hdr.status == ZSuccess ) )
   \   000004   90....       MOV     DPTR,#ZDNwkMgr_WaitingForNotifyConfirm
   \   000007   E0           MOVX    A,@DPTR
   \   000008   6023         JZ      ??ZDNwkMgr_ProcessDataConfirm_0
   \   00000A   8A82         MOV     DPL,R2
   \   00000C   8B83         MOV     DPH,R3
   \   00000E   A3           INC     DPTR
   \   00000F   A3           INC     DPTR
   \   000010   A3           INC     DPTR
   \   000011   E0           MOVX    A,@DPTR
   \   000012   7019         JNZ     ??ZDNwkMgr_ProcessDataConfirm_0
   \   000014   8A82         MOV     DPL,R2
   \   000016   8B83         MOV     DPH,R3
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   7011         JNZ     ??ZDNwkMgr_ProcessDataConfirm_0
    943            {
    944              // The Mgmt NWK Update Notify was sent as an APS Unicast with  
    945              // acknowledgement and once the acknowledgment is received the 
    946              // total transmit and transmit failure counters are reset to zero.  
    947              _NIB.nwkTotalTransmissions = 0;
   \   00001C   90....       MOV     DPTR,#(_NIB + 107)
   \   00001F   E4           CLR     A
   \   000020   F0           MOVX    @DPTR,A
   \   000021   A3           INC     DPTR
   \   000022   F0           MOVX    @DPTR,A
    948              nwkTransmissionFailures( TRUE );
   \   000023                ; Setup parameters for call to function nwkTransmissionFailures
   \   000023   7901         MOV     R1,#0x1
   \   000025   12....       LCALL   ??nwkTransmissionFailures?relay
    949              
    950              ZDNwkMgr_WaitingForNotifyConfirm = FALSE;
   \   000028   E4           CLR     A
   \   000029   90....       MOV     DPTR,#ZDNwkMgr_WaitingForNotifyConfirm
   \   00002C   F0           MOVX    @DPTR,A
    951            }
    952          }
   \                     ??ZDNwkMgr_ProcessDataConfirm_0:
   \   00002D   D083         POP     DPH
   \   00002F   D082         POP     DPL
   \   000031   02....       LJMP    ?BRET

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_event_loop?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_event_loop

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessMsgCBs?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessMsgCBs

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessMgmtNwkUpdateReq

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessServerDiscRsp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessServerDiscRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessChannelInterference?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessChannelInterference

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessEDScanConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessEDScanConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_CheckForChannelInterference?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_CheckForChannelInterference

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_BuildAndSendUpdateNotify

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_SetNwkManagerAddr?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_SetNwkManagerAddr

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ReportChannelInterference?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ReportChannelInterference

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_EDScanConfirmCB?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_EDScanConfirmCB

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ZDNwkMgr_ProcessDataConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ZDNwkMgr_ProcessDataConfirm

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant ": ">`:
   \   000000   3A2000       DB ": "

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_0:
   \   000000   00000000     DD 0

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_7fff800:
   \   000000   00F8FF07     DD 134215680
    953          
    954          /*********************************************************************
    955           * PAN ID Conflict Routines
    956           */
    957          #if defined ( NWK_MANAGER )
    958          /*********************************************************************
    959           * @fn          ZDNwkMgr_NetworkReportCB
    960           *
    961           * @brief       Handle the Network Report Command
    962           *
    963           * @param       srcAddr     - Source Address of the message.
    964           * @param       status      - ZSuccess.
    965           * @param       serverMask  - Bit mask of services matching the req serverMask.
    966           * @param       securityUse -
    967           *
    968           * @return      none
    969           */
    970          void ZDNwkMgr_NetworkReportCB( ZDNwkMgr_NetworkReport_t *pReport )
    971          { 
    972            // Send Network Report message to the Network Manager task
    973            osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pReport );
    974          }
    975          
    976          /*********************************************************************
    977           * @fn          ZDNwkMgr_NetworkUpdateCB
    978           *
    979           * @brief       Handle the Network Update Command
    980           *
    981           * @param       srcAddr     - Source Address of the message.
    982           * @param       status      - ZSuccess.
    983           * @param       serverMask  - Bit mask of services matching the req serverMask.
    984           * @param       securityUse -
    985           *
    986           * @return      none
    987           */
    988          void ZDNwkMgr_NetworkUpdateCB( ZDNwkMgr_NetworkUpdate_t *pUpdate )
    989          {
    990            // Send Network Update message to the Network Manager task
    991            osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pUpdate );
    992          }
    993          
    994          /*********************************************************************
    995           * @fn      ZDNwkMgr_ProcessNetworkReport
    996           *
    997           * @brief   Process the incoming Network Report message
    998           *
    999           * @param   pNetworkReport - Structure containing Network Report message
   1000           *
   1001           * @return  none
   1002           */
   1003          void ZDNwkMgr_ProcessNetworkReport( ZDNwkMgr_NetworkReport_t *pNetworkReport )
   1004          {
   1005            uint8 i;
   1006            uint16 newPID;
   1007            uint8 unique = TRUE;
   1008          
   1009            if ( pNetworkReport->reportType == NWKREPORT_PANID_CONFLICT )
   1010            {
   1011              if ( ZDNwkMgr_PanIdUpdateInProgress == FALSE )
   1012              {
   1013                do
   1014                {
   1015                  // select a new PAN ID
   1016                  newPID = (uint16)osal_rand();
   1017                
   1018                  // Make sure that the chosen PAN ID is not already in use in the
   1019                  // local neighborhood and also not contained within the Report 
   1020                  // Information field of the Network Report Command frame
   1021                  for ( i = 0; i < pNetworkReport->reportInfoCnt; i++ )
   1022                  {
   1023                    if ( pNetworkReport->panIDs[i] == newPID )
   1024                    {
   1025                      unique = FALSE;
   1026                      break;
   1027                    }
   1028                  }
   1029                } while ( !unique );
   1030                   
   1031                // Send out a Network Update command.
   1032                NLME_SendNetworkUpdate( NWK_BROADCAST_SHORTADDR, NWKUPDATE_PANID_UPDATE,
   1033                                        _NIB.extendedPANID, _NIB.nwkUpdateId+1, newPID );
   1034              
   1035                ZDNwkMgr_PanIdUpdateInProgress = TRUE;
   1036              }
   1037            }
   1038          }
   1039          
   1040          /*********************************************************************
   1041           * @fn      ZDNwkMgr_ProcessNetworkUpdate
   1042           *
   1043           * @brief   Process the incoming Network Update message
   1044           *
   1045           * @param   pNetworkReport - Structure containing Network Update message
   1046           *
   1047           * @return  none
   1048           */
   1049          void ZDNwkMgr_ProcessNetworkUpdate( ZDNwkMgr_NetworkUpdate_t *pNetworkUpdate )
   1050          {
   1051            if ( pNetworkUpdate->updateType == NWKUPDATE_PANID_UPDATE )
   1052            { 
   1053              // Our PAN ID has been changed -- notify to save info into NV
   1054              ZDApp_NwkStateUpdateCB();
   1055              
   1056              ZDNwkMgr_PanIdUpdateInProgress = FALSE;
   1057            }
   1058          }
   1059          #endif // NWK_MANAGER
   1060          
   1061          
   1062          /*********************************************************************
   1063          *********************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     ZDNwkMgr_BuildAndSendUpdateNotify
                                        1      0     53
       -> osal_mem_alloc                0      0     40
       -> ZDP_MgmtNwkUpdateNotify       0      0     64
       -> osal_mem_free                 0      0     40
     ZDNwkMgr_CheckForChannelInterference
                                        0      0     35
       -> ZDNwkMgr_BuildAndSendUpdateNotify
                                        0      0     42
       -> osal_start_timerEx            0      0     32
       -> HalLcdWriteString             0      0     32
       -> HalLcdWriteStringValueValue
                                        0      0     40
     ZDNwkMgr_EDScanConfirmCB           1      0     17
       -> osal_msg_allocate             0      0     28
       -> osal_memcpy                   0      0     34
       -> osal_msg_send                 0      0     28
     ZDNwkMgr_Init                      2      0      0
       -> ZDO_RegisterForZDOMsg         4      0      0
       -> ZDO_RegisterForZDOMsg         4      0      0
     ZDNwkMgr_ProcessChannelInterference
                                        0      0     24
       -> NLME_EDScanRequest            0      0     24
     ZDNwkMgr_ProcessDataConfirm        2      0      0
       -> nwkTransmissionFailures       4      0      0
     ZDNwkMgr_ProcessEDScanConfirm      0      0     31
       -> ZDNwkMgr_CheckForChannelInterference
                                        0      0     28
       -> nwkTransmissionFailures       0      0     28
       -> ZDNwkMgr_BuildAndSendUpdateNotify
                                        0      0     38
       -> osal_start_timerEx            0      0     28
     ZDNwkMgr_ProcessMgmtNwkUpdateReq
                                        2      0     43
       -> ZDO_ParseMgmtNwkUpdateReq     0      0     42
       -> NLME_EDScanRequest            0      0     42
       -> NLME_SetUpdateID              0      0     42
       -> osal_start_timerEx            0      0     42
       -> NLME_SetUpdateID              0      0     42
       -> ZDApp_NwkStateUpdateCB        0      0     42
       -> ZDNwkMgr_SetNwkManagerAddr
                                        0      0     42
       -> ZDP_MgmtNwkUpdateNotify       0      0     66
     ZDNwkMgr_ProcessMsgCBs             0      0     22
       -> ZDNwkMgr_ProcessMgmtNwkUpdateReq
                                        0      0     20
       -> ZDNwkMgr_ProcessServerDiscRsp
                                        0      0     20
     ZDNwkMgr_ProcessServerDiscRsp      0      0     22
       -> ZDO_ParseServerDiscRsp        0      0     24
       -> ZDNwkMgr_SetNwkManagerAddr
                                        0      0     24
     ZDNwkMgr_ReportChannelInterference
                                        1      0     10
       -> osal_msg_allocate             0      0     20
       -> osal_msg_send                 0      0     20
     ZDNwkMgr_SetNwkManagerAddr         2      0     21
       -> ZDApp_NwkStateUpdateCB        4      0      0
     ZDNwkMgr_event_loop                0      0     12
       -> osal_msg_receive              0      0     24
       -> ZDNwkMgr_ProcessEDScanConfirm
                                        0      0     24
       -> osal_msg_deallocate           0      0     24
       -> osal_msg_receive              0      0     24
       -> ZDNwkMgr_ProcessMsgCBs        0      0     24
       -> ZDNwkMgr_ProcessChannelInterference
                                        0      0     24
       -> ZMacSetReq                    0      0     24
       -> ZDApp_NwkStateUpdateCB        0      0     24
       -> nwkTransmissionFailures       0      0     24
       -> osal_start_timerEx            0      0     24
       -> NLME_EDScanRequest            0      0     24


   Segment part sizes:

     Function/Label                               Bytes
     --------------                               -----
     NwkMgrStr_1                                    15
     NwkMgrStr_2                                    17
     NwkMgrStr_3                                    17
     NwkMgrStr_4                                    17
     ZDNwkMgr_TaskID                                 1
     ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq
                                                     1
     ZDNwkMgr_MgmtNwkUpdateNotifyAddr
                                                     9
     ZDNwkMgr_UpdateNotifyTimer                      2
     ZDNwkMgr_NumUpdateNotifySent                    1
     ZDNwkMgr_WaitingForNotifyConfirm
                                                     1
     ZDNwkMgr_TotalTransmissions                     2
     ZDNwkMgr_TxFailures                             2
     ZDNwkMgr_MgmtNwkUpdateReq                       9
     ZDNwkMgr_NewChannel                             1
     pZDNwkMgr_ReportChannelInterference
                                                     2
     pZDNwkMgr_ProcessDataConfirm                    2
     pZDNwkMgr_EDScanConfirmCB                       2
     pZDNwkMgr_NetworkReportCB                       2
     pZDNwkMgr_NetworkUpdateCB                       2
     ZDNwkMgr_Init                                  83
     ZDNwkMgr_event_loop                           259
     ZDNwkMgr_ProcessMsgCBs                         54
     ZDNwkMgr_ProcessMgmtNwkUpdateReq
                                                   507
     ZDNwkMgr_ProcessServerDiscRsp                  70
     ZDNwkMgr_ProcessChannelInterference
                                                    96
     ZDNwkMgr_ProcessEDScanConfirm                 106
     ZDNwkMgr_CheckForChannelInterference
                                                   317
     ZDNwkMgr_BuildAndSendUpdateNotify
                                                   398
     ZDNwkMgr_SetNwkManagerAddr                     34
     ZDNwkMgr_ReportChannelInterference
                                                    86
     ZDNwkMgr_EDScanConfirmCB                      148
     ZDNwkMgr_ProcessDataConfirm                    52
     ??ZDNwkMgr_Init?relay                           6
     ??ZDNwkMgr_event_loop?relay                     6
     ??ZDNwkMgr_ProcessMsgCBs?relay                  6
     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq?relay        6
     ??ZDNwkMgr_ProcessServerDiscRsp?relay           6
     ??ZDNwkMgr_ProcessChannelInterference?relay     6
     ??ZDNwkMgr_ProcessEDScanConfirm?relay           6
     ??ZDNwkMgr_CheckForChannelInterference?relay    6
     ??ZDNwkMgr_BuildAndSendUpdateNotify?relay       6
     ??ZDNwkMgr_SetNwkManagerAddr?relay              6
     ??ZDNwkMgr_ReportChannelInterference?relay      6
     ??ZDNwkMgr_EDScanConfirmCB?relay                6
     ??ZDNwkMgr_ProcessDataConfirm?relay             6
     ?<Constant ": ">                                3
     __Constant_0                                    4
     __Constant_7fff800                              4

 
 2 210 bytes in segment BANKED_CODE
    78 bytes in segment BANK_RELAYS
    77 bytes in segment XDATA_ROM_C
    39 bytes in segment XDATA_Z
 
 2 288 bytes of CODE  memory
    69 bytes of CONST memory (+ 8 bytes shared)
    39 bytes of XDATA memory

Errors: none
Warnings: none
