###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.40194/W32 for 8051         23/Jan/2014  09:40:54 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\wise-house\Components\mt\MT_TASK.c              #
#    Command line       =  -f E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg  #
#                          (-DCPU32MHZ -DROOT=__near_func                     #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f E:\wise-house\Projects\zsta #
#                          ck\Samples\MyGenericApp\CC2530DB\..\..\..\Tools\CC #
#                          2530DB\f8wConfig.cfg (-DZIGBEEPRO -DSECURE=0       #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=TRUE -DPOLL_RATE=1000         #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 E:\wise-house\Components\mt #
#                          \MT_TASK.c -D NWK_AUTO_POLL -D ZTOOL_P1 -D         #
#                          MT_TASK -D MT_SYS_FUNC -D MT_ZDO_FUNC -D           #
#                          LCD_SUPPORTED=DEBUG -D xPOWER_SAVING -lC           #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\EndDeviceEB\List\ -lA                    #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\EndDeviceEB\List\ --diag_suppress        #
#                          Pe001,Pa010 -o E:\wise-house\Projects\zstack\Sampl #
#                          es\MyGenericApp\CC2530DB\EndDeviceEB\Obj\ -e       #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\ -I E:\wise-house\Projects\zstack\Sam #
#                          ples\MyGenericApp\CC2530DB\..\Source\ -I           #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\ZMain\TI2530DB\ -I              #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\hal\include\   #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\..\..\Components\hal\target\ #
#                          CC2530EB\ -I E:\wise-house\Projects\zstack\Samples #
#                          \MyGenericApp\CC2530DB\..\..\..\..\..\Components\m #
#                          ac\include\ -I E:\wise-house\Projects\zstack\Sampl #
#                          es\MyGenericApp\CC2530DB\..\..\..\..\..\Components #
#                          \mac\high_level\ -I E:\wise-house\Projects\zstack\ #
#                          Samples\MyGenericApp\CC2530DB\..\..\..\..\..\Compo #
#                          nents\mac\low_level\srf04\ -I                      #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\mac\low_level\ #
#                          srf04\single_chip\ -I E:\wise-house\Projects\zstac #
#                          k\Samples\MyGenericApp\CC2530DB\..\..\..\..\..\Com #
#                          ponents\mt\ -I E:\wise-house\Projects\zstack\Sampl #
#                          es\MyGenericApp\CC2530DB\..\..\..\..\..\Components #
#                          \osal\include\ -I E:\wise-house\Projects\zstack\Sa #
#                          mples\MyGenericApp\CC2530DB\..\..\..\..\..\Compone #
#                          nts\services\saddr\ -I E:\wise-house\Projects\zsta #
#                          ck\Samples\MyGenericApp\CC2530DB\..\..\..\..\..\Co #
#                          mponents\services\sdata\ -I                        #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\af\ -I   #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\nwk\ -I  #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\sapi\    #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\..\..\Components\stack\sec\  #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\..\..\Components\stack\sys\  #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\..\..\Components\stack\zdo\  #
#                          -I E:\wise-house\Projects\zstack\Samples\MyGeneric #
#                          App\CC2530DB\..\..\..\..\..\Components\zmac\ -I    #
#                          E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\..\..\..\..\..\Components\zmac\f8w\ -Ohz #
#    List file          =  E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\EndDeviceEB\List\MT_TASK.lst             #
#    Object file        =  E:\wise-house\Projects\zstack\Samples\MyGenericApp #
#                          \CC2530DB\EndDeviceEB\Obj\MT_TASK.r51              #
#                                                                             #
#                                                                             #
###############################################################################

E:\wise-house\Components\mt\MT_TASK.c
      1          /***************************************************************************************************
      2            Filename:       MT_TASK.c
      3            Revised:        $Date: 2011-06-07 15:36:01 -0700 (Tue, 07 Jun 2011) $
      4            Revision:       $Revision: 26245 $
      5          
      6            Description:    MonitorTest Task handling routines
      7          
      8            Copyright 2007-2011 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT_TASK.h"
     45          #include "MT.h"
     46          #include "MT_DEBUG.h"
     47          #include "MT_UART.h"
     48          #include "MT_UTIL.h"
     49          #include "MT_SYS.h"
     50          
     51          #if !defined( NONWK )
     52          #include "MT_ZDO.h"
     53          #include "MT_AF.h"
     54          #endif  /* NONWK */
     55          
     56          #include "hal_uart.h"
     57          #include "OSAL_Memory.h"
     58          #include "chdebug.h"
     59          
     60          /***************************************************************************************************
     61           * LOCAL FUNCTIONS
     62           ***************************************************************************************************/
     63          
     64          static void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg );
     65          
     66          /***************************************************************************************************
     67           * GLOBALS
     68           ***************************************************************************************************/
     69          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     70          uint8 MT_TaskID;
   \                     MT_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
     71          
     72          /***************************************************************************************************
     73           * @fn      MT_TaskInit
     74           *
     75           * @brief  MonitorTest Task Initialization.  This function is put into the
     76           *         task table.
     77           *
     78           * @param   task_id - task ID of the MT Task
     79           *
     80           * @return  void
     81           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     82          void MT_TaskInit(uint8 task_id)
   \                     MT_TaskInit:
     83          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
     84            MT_TaskID = task_id;
   \   000007   90....       MOV     DPTR,#MT_TaskID
   \   00000A   F0           MOVX    @DPTR,A
     85          
     86            /* Initialize the Serial port */
     87            MT_UartInit();
   \   00000B                ; Setup parameters for call to function MT_UartInit
   \   00000B   12....       LCALL   ??MT_UartInit?relay
     88          
     89            /* Register taskID - Do this after UartInit() because it will reset the taskID */
     90            MT_UartRegisterTaskID(task_id);
   \   00000E                ; Setup parameters for call to function MT_UartRegisterTaskID
   \   00000E   EE           MOV     A,R6
   \   00000F   F9           MOV     R1,A
   \   000010   12....       LCALL   ??MT_UartRegisterTaskID?relay
     91          
     92            osal_set_event(task_id, MT_SECONDARY_INIT_EVENT);
   \   000013                ; Setup parameters for call to function osal_set_event
   \   000013   7A10         MOV     R2,#0x10
   \   000015   7B00         MOV     R3,#0x0
   \   000017   EE           MOV     A,R6
   \   000018   F9           MOV     R1,A
   \   000019   12....       LCALL   ??osal_set_event?relay
     93          }
   \   00001C   7F01         MOV     R7,#0x1
   \   00001E   02....       LJMP    ?BANKED_LEAVE_XDATA
     94          
     95          /**************************************************************************************************
     96           * @fn      MT_ProcessEvent
     97           *
     98           * @brief   MonitorTest Task Event Processor.  This task is put into the task table.
     99           *
    100           * @param   task_id - task ID of the MT Task
    101           * @param   events - event(s) for the MT Task
    102           *
    103           * @return  Bit mask of the unprocessed MT Task events.
    104           **************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    105          UINT16 MT_ProcessEvent(uint8 task_id, uint16 events)
   \                     MT_ProcessEvent:
    106          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    107            /* Could be multiple events, so switch won't work */
    108            if ( events & SYS_EVENT_MSG )
   \   000009   5480         ANL     A,#0x80
   \   00000B   7003         JNZ     $+5
   \   00000D   02....       LJMP    ??MT_ProcessEvent_0 & 0xFFFF
    109            {
    110              uint8 *msg_ptr = osal_msg_receive(task_id);
   \   000010                ; Setup parameters for call to function osal_msg_receive
   \   000010   12....       LCALL   ??osal_msg_receive?relay
   \   000013   8A..         MOV     ?V0 + 2,R2
   \   000015   8B..         MOV     ?V0 + 3,R3
    111          
    112              if (msg_ptr != NULL)
   \   000017   EA           MOV     A,R2
   \   000018   45..         ORL     A,?V0 + 3
   \   00001A   7003         JNZ     $+5
   \   00001C   02....       LJMP    ??MT_ProcessEvent_1 & 0xFFFF
    113              {
    114                MT_ProcessIncomingCommand((mtOSALSerialData_t *)msg_ptr);
   \   00001F   8A82         MOV     DPL,R2
   \   000021   8B83         MOV     DPH,R3
   \   000023   A3           INC     DPTR
   \   000024   A3           INC     DPTR
   \   000025   E0           MOVX    A,@DPTR
   \   000026   F5..         MOV     ?V0 + 0,A
   \   000028   A3           INC     DPTR
   \   000029   E0           MOVX    A,@DPTR
   \   00002A   F5..         MOV     ?V0 + 1,A
   \   00002C   8A82         MOV     DPL,R2
   \   00002E   8B83         MOV     DPH,R3
   \   000030   E0           MOVX    A,@DPTR
   \   000031   14           DEC     A
   \   000032   607A         JZ      ??MT_ProcessEvent_2
   \   000034   14           DEC     A
   \   000035   6072         JZ      ??MT_ProcessEvent_3
   \   000037   24FE         ADD     A,#-0x2
   \   000039   6023         JZ      ??MT_ProcessEvent_4
   \   00003B   24FE         ADD     A,#-0x2
   \   00003D   601A         JZ      ??MT_ProcessEvent_5
   \   00003F   24E2         ADD     A,#-0x1e
   \   000041   7072         JNZ     ??MT_ProcessEvent_6
   \   000043                ; Setup parameters for call to function MTProcessAppRspMsg
   \   000043   85..82       MOV     DPL,?V0 + 0
   \   000046   85..83       MOV     DPH,?V0 + 1
   \   000049   A3           INC     DPTR
   \   00004A   A3           INC     DPTR
   \   00004B   A3           INC     DPTR
   \   00004C   E0           MOVX    A,@DPTR
   \   00004D   2405         ADD     A,#0x5
   \   00004F   F9           MOV     R1,A
   \   000050   AA..         MOV     R2,?V0 + 0
   \   000052   AB..         MOV     R3,?V0 + 1
   \   000054   12....       LCALL   ??MTProcessAppRspMsg?relay
   \   000057   805C         SJMP    ??MT_ProcessEvent_6
   \                     ??MT_ProcessEvent_5:
   \   000059                ; Setup parameters for call to function MT_ProcessDebugStr
   \   000059   12....       LCALL   ??MT_ProcessDebugStr?relay
   \   00005C   8057         SJMP    ??MT_ProcessEvent_6
   \                     ??MT_ProcessEvent_4:
   \   00005E   85..82       MOV     DPL,?V0 + 0
   \   000061   85..83       MOV     DPH,?V0 + 1
   \   000064   A3           INC     DPTR
   \   000065   A3           INC     DPTR
   \   000066   A3           INC     DPTR
   \   000067   E0           MOVX    A,@DPTR
   \   000068   2405         ADD     A,#0x5
   \   00006A   F5..         MOV     ?V0 + 5,A
   \   00006C                ; Setup parameters for call to function MT_UartCalcFCS
   \   00006C   74FE         MOV     A,#-0x2
   \   00006E   25..         ADD     A,?V0 + 5
   \   000070   F9           MOV     R1,A
   \   000071   85..82       MOV     DPL,?V0 + 0
   \   000074   85..83       MOV     DPH,?V0 + 1
   \   000077   A3           INC     DPTR
   \   000078   AA82         MOV     R2,DPL
   \   00007A   AB83         MOV     R3,DPH
   \   00007C   12....       LCALL   ??MT_UartCalcFCS?relay
   \   00007F   E9           MOV     A,R1
   \   000080   C0E0         PUSH    A
   \   000082   85....       MOV     ?V0 + 6,?V0 + 5
   \   000085   E5..         MOV     A,?V0 + 0
   \   000087   25..         ADD     A,?V0 + 6
   \   000089   F8           MOV     R0,A
   \   00008A   E5..         MOV     A,?V0 + 1
   \   00008C   3400         ADDC    A,#0x0
   \   00008E   F9           MOV     R1,A
   \   00008F   E8           MOV     A,R0
   \   000090   24FF         ADD     A,#-0x1
   \   000092   F582         MOV     DPL,A
   \   000094   E9           MOV     A,R1
   \   000095   34FF         ADDC    A,#-0x1
   \   000097   F583         MOV     DPH,A
   \   000099   D0E0         POP     A
   \   00009B   F0           MOVX    @DPTR,A
   \   00009C                ; Setup parameters for call to function UartSend
   \   00009C   AC..         MOV     R4,?V0 + 6
   \   00009E   7D00         MOV     R5,#0x0
   \   0000A0   AA..         MOV     R2,?V0 + 0
   \   0000A2   AB..         MOV     R3,?V0 + 1
   \   0000A4   12....       LCALL   ??UartSend?relay
   \   0000A7   800C         SJMP    ??MT_ProcessEvent_6
   \                     ??MT_ProcessEvent_3:
   \   0000A9                ; Setup parameters for call to function MT_ProcessDebugMsg
   \   0000A9   12....       LCALL   ??MT_ProcessDebugMsg?relay
   \   0000AC   8007         SJMP    ??MT_ProcessEvent_6
   \                     ??MT_ProcessEvent_2:
   \   0000AE                ; Setup parameters for call to function MT_ProcessIncoming
   \   0000AE   AA..         MOV     R2,?V0 + 0
   \   0000B0   AB..         MOV     R3,?V0 + 1
   \   0000B2   12....       LCALL   ??MT_ProcessIncoming?relay
    115          
    116                osal_msg_deallocate(msg_ptr);
   \                     ??MT_ProcessEvent_6:
   \   0000B5                ; Setup parameters for call to function osal_msg_deallocate
   \   0000B5   AA..         MOV     R2,?V0 + 2
   \   0000B7   AB..         MOV     R3,?V0 + 3
   \   0000B9   12....       LCALL   ??osal_msg_deallocate?relay
    117              }
    118          
    119              /* Return unproccessed events */
    120              return (events ^ SYS_EVENT_MSG);
   \                     ??MT_ProcessEvent_1:
   \   0000BC   EE           MOV     A,R6
   \   0000BD   FA           MOV     R2,A
   \   0000BE   EF           MOV     A,R7
   \   0000BF   6480         XRL     A,#0x80
   \                     ??MT_ProcessEvent_7:
   \   0000C1   FB           MOV     R3,A
   \   0000C2   806B         SJMP    ??MT_ProcessEvent_8
    121            }
    122          
    123            if ( events & MT_SECONDARY_INIT_EVENT )
   \                     ??MT_ProcessEvent_0:
   \   0000C4   EE           MOV     A,R6
   \   0000C5   5410         ANL     A,#0x10
   \   0000C7   600A         JZ      ??MT_ProcessEvent_9
    124            {
    125              MT_Init();
   \   0000C9                ; Setup parameters for call to function MT_Init
   \   0000C9   12....       LCALL   ??MT_Init?relay
    126              /* Return unproccessed events */
    127              return (events ^ MT_SECONDARY_INIT_EVENT);
   \   0000CC   EE           MOV     A,R6
   \   0000CD   6410         XRL     A,#0x10
   \                     ??MT_ProcessEvent_10:
   \   0000CF   FA           MOV     R2,A
   \   0000D0   EF           MOV     A,R7
   \   0000D1   80EE         SJMP    ??MT_ProcessEvent_7
    128            }
    129          
    130            if ( events & MT_ZTOOL_SERIAL_RCV_BUFFER_FULL )
   \                     ??MT_ProcessEvent_9:
   \   0000D3   EE           MOV     A,R6
   \   0000D4   5402         ANL     A,#0x2
   \   0000D6   6006         JZ      ??MT_ProcessEvent_11
    131            {
    132              /* Return unproccessed events */
    133              return (events ^ MT_ZTOOL_SERIAL_RCV_BUFFER_FULL);
   \   0000D8   EE           MOV     A,R6
   \   0000D9   6402         XRL     A,#0x2
   \   0000DB   FA           MOV     R2,A
   \   0000DC   8051         SJMP    ??MT_ProcessEvent_8
    134            }
    135          
    136          #if !defined( NONWK )
    137            if ( events & MT_AF_EXEC_EVT )
   \                     ??MT_ProcessEvent_11:
   \   0000DE   EE           MOV     A,R6
   \   0000DF   5408         ANL     A,#0x8
   \   0000E1   6008         JZ      ??MT_ProcessEvent_12
    138            {
    139              MT_AfExec();
   \   0000E3                ; Setup parameters for call to function MT_AfExec
   \   0000E3   12....       LCALL   ??MT_AfExec?relay
    140              return (events ^ MT_AF_EXEC_EVT);
   \   0000E6   EE           MOV     A,R6
   \   0000E7   6408         XRL     A,#0x8
   \   0000E9   80E4         SJMP    ??MT_ProcessEvent_10
    141            }
    142          #endif  /* NONWK */
    143          
    144            /* Handle MT_SYS_OSAL_START_TIMER callbacks */
    145          #if defined MT_SYS_FUNC
    146            if ( events & (MT_SYS_OSAL_EVENT_MASK))
   \                     ??MT_ProcessEvent_12:
   \   0000EB   EF           MOV     A,R7
   \   0000EC   540F         ANL     A,#0xf
   \   0000EE   603B         JZ      ??MT_ProcessEvent_13
    147            {
    148              if (events & MT_SYS_OSAL_EVENT_0)
   \   0000F0   EF           MOV     A,R7
   \   0000F1   5408         ANL     A,#0x8
   \   0000F3   6009         JZ      ??MT_ProcessEvent_14
    149              {
    150                MT_SysOsalTimerExpired(0x00);
   \   0000F5                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   0000F5   7900         MOV     R1,#0x0
   \   0000F7   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    151                events ^= MT_SYS_OSAL_EVENT_0;
   \   0000FA   7408         MOV     A,#0x8
   \   0000FC   6F           XRL     A,R7
   \   0000FD   FF           MOV     R7,A
    152              }
    153          
    154              if (events & MT_SYS_OSAL_EVENT_1)
   \                     ??MT_ProcessEvent_14:
   \   0000FE   EF           MOV     A,R7
   \   0000FF   5404         ANL     A,#0x4
   \   000101   6009         JZ      ??MT_ProcessEvent_15
    155              {
    156                MT_SysOsalTimerExpired(0x01);
   \   000103                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000103   7901         MOV     R1,#0x1
   \   000105   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    157                events ^= MT_SYS_OSAL_EVENT_1;
   \   000108   7404         MOV     A,#0x4
   \   00010A   6F           XRL     A,R7
   \   00010B   FF           MOV     R7,A
    158              }
    159          
    160              if (events & MT_SYS_OSAL_EVENT_2)
   \                     ??MT_ProcessEvent_15:
   \   00010C   EF           MOV     A,R7
   \   00010D   5402         ANL     A,#0x2
   \   00010F   6009         JZ      ??MT_ProcessEvent_16
    161              {
    162                MT_SysOsalTimerExpired(0x02);
   \   000111                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000111   7902         MOV     R1,#0x2
   \   000113   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    163                events ^= MT_SYS_OSAL_EVENT_2;
   \   000116   7402         MOV     A,#0x2
   \   000118   6F           XRL     A,R7
   \   000119   FF           MOV     R7,A
    164              }
    165          
    166              if (events & MT_SYS_OSAL_EVENT_3)
   \                     ??MT_ProcessEvent_16:
   \   00011A   EF           MOV     A,R7
   \   00011B   5401         ANL     A,#0x1
   \   00011D   6009         JZ      ??MT_ProcessEvent_17
    167              {
    168                MT_SysOsalTimerExpired(0x03);
   \   00011F                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   00011F   7903         MOV     R1,#0x3
   \   000121   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    169                events ^= MT_SYS_OSAL_EVENT_3;
   \   000124   7401         MOV     A,#0x1
   \   000126   6F           XRL     A,R7
   \   000127   FF           MOV     R7,A
    170              }
    171          
    172              return events;
   \                     ??MT_ProcessEvent_17:
   \   000128   EE           MOV     A,R6
   \   000129   80A4         SJMP    ??MT_ProcessEvent_10
    173            }
    174          #endif
    175          
    176            /* Discard or make more handlers */
    177            return 0;
   \                     ??MT_ProcessEvent_13:
   \   00012B   7A00         MOV     R2,#0x0
   \   00012D   7B00         MOV     R3,#0x0
   \                     ??MT_ProcessEvent_8:
   \   00012F   7F08         MOV     R7,#0x8
   \   000131   02....       LJMP    ?BANKED_LEAVE_XDATA
    178          
    179          } /* MT_ProcessEvent() */
    180          
    181          /***************************************************************************************************
    182           * @fn      MT_ProcessIncomingCommand
    183           *
    184           * @brief
    185           *
    186           *   Process Event Messages.
    187           *
    188           * @param   *msg - pointer to event message
    189           *
    190           * @return
    191           ***************************************************************************************************/
    192          static void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg )
    193          {
    194            uint8 len, *msg_ptr = msg->msg;
    195          
    196            /* Use the first byte of the message as the command ID */
    197            switch ( msg->hdr.event )
    198            {
    199              case CMD_SERIAL_MSG:
    200                MT_ProcessIncoming(msg_ptr);
    201                break;
    202          
    203              case CMD_DEBUG_MSG:
    204                MT_ProcessDebugMsg( (mtDebugMsg_t *)msg );
    205                break;
    206          
    207              case CB_FUNC:
    208                /*
    209                  Build SPI message here instead of redundantly calling MT_BuildSPIMsg
    210                  because we have copied data already in the allocated message
    211                */
    212          
    213                /* msg_ptr is the beginning of the intended SPI message */
    214                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    215          
    216                /*
    217                  FCS goes to the last byte in the message and is calculated over all
    218                  the bytes except FCS and SOP
    219                */
    220                msg_ptr[len-1] = MT_UartCalcFCS(msg_ptr + 1, (uint8)(len-2));
    221          
    222          #ifdef MT_UART_DEFAULT_PORT
    223                //HalUARTWrite ( MT_UART_DEFAULT_PORT, msg_ptr, len );
    224                dbgsend((  msg_ptr, len ));
    225          #endif
    226                break;
    227          
    228              case CMD_DEBUG_STR:
    229                MT_ProcessDebugStr( (mtDebugStr_t *)msg );
    230                break;
    231          
    232          #if !defined ( NONWK )
    233              case MT_SYS_APP_RSP_MSG:
    234                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    235                MTProcessAppRspMsg( msg_ptr, len );
    236                break;
    237          #endif  // NONWK
    238          
    239          #if defined (MT_UTIL_FUNC)
    240          #if defined ZCL_KEY_ESTABLISH
    241              case ZCL_KEY_ESTABLISH_IND:
    242                MT_UtilKeyEstablishInd((keyEstablishmentInd_t *)msg);
    243                break;
    244          #endif
    245          #endif
    246          #ifdef MT_ZDO_CB_FUNC
    247              case ZDO_STATE_CHANGE:
    248                MT_ZdoStateChangeCB((osal_event_hdr_t *)msg);
    249                break;
    250          #endif
    251          
    252              default:
    253                break;
    254            }
    255          }
    256          
    257          #ifdef MT_TASK
    258          /***************************************************************************************************
    259           * @fn      MT_TransportAlloc
    260           *
    261           * @brief   Allocate memory for transport msg
    262           *
    263           * @param   uint8 cmd0 - The first byte of the MT command id containing the command type and subsystem.
    264           *          uint8 len - length
    265           *
    266           * @return  pointer the allocated memory or NULL if fail to allocate the memory
    267           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    268          uint8 *MT_TransportAlloc(uint8 cmd0, uint8 len)
   \                     MT_TransportAlloc:
    269          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
    270            uint8 *p;
    271          
    272            (void)cmd0;  // Intentionally unreferenced parameter
    273          
    274            /* Allocate a buffer of data length + SOP+CMD+FCS (5 bytes) */
    275            p = osal_msg_allocate(len + SPI_0DATA_MSG_LEN);
   \   000006                ; Setup parameters for call to function osal_msg_allocate
   \   000006   2405         ADD     A,#0x5
   \   000008   FA           MOV     R2,A
   \   000009   E4           CLR     A
   \   00000A   3400         ADDC    A,#0x0
   \   00000C   FB           MOV     R3,A
   \   00000D   12....       LCALL   ??osal_msg_allocate?relay
   \   000010   8A82         MOV     DPL,R2
   \   000012   8B83         MOV     DPH,R3
    276          
    277            if (p)
   \   000014   E582         MOV     A,DPL
   \   000016   4583         ORL     A,DPH
   \   000018   6007         JZ      ??MT_TransportAlloc_0
    278            {
    279              p++; /* Save space for SOP_VALUE, msg structure */
    280              return p;
   \   00001A   A3           INC     DPTR
   \   00001B   AA82         MOV     R2,DPL
   \   00001D   AB83         MOV     R3,DPH
   \   00001F   8004         SJMP    ??MT_TransportAlloc_1
    281            }
    282            else
    283            {
    284              return NULL;
   \                     ??MT_TransportAlloc_0:
   \   000021   7A00         MOV     R2,#0x0
   \   000023   7B00         MOV     R3,#0x0
    285            }
   \                     ??MT_TransportAlloc_1:
   \   000025                REQUIRE ?Subroutine0
   \   000025                ; // Fall through to label ?Subroutine0
    286          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F02         MOV     R7,#0x2
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    287          
    288          /***************************************************************************************************
    289           * @fn      MT_TransportSend
    290           *
    291           * @brief   Fill in SOP and FCS then send out the msg
    292           *
    293           * @param   uint8 *pBuf - pointer to the message that contains CMD, length, data and FCS
    294           *
    295           * @return  None
    296           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    297          void MT_TransportSend(uint8 *pBuf)
   \                     MT_TransportSend:
    298          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    299            uint8 *msgPtr;
    300            uint8 dataLen = pBuf[0]; /* Data length is on byte #1 from the pointer */
   \   000005   8A82         MOV     DPL,R2
   \   000007   8B83         MOV     DPH,R3
   \   000009   E0           MOVX    A,@DPTR
   \   00000A   F9           MOV     R1,A
    301          
    302            /* Move back to the SOP */
    303            msgPtr = pBuf-1;
   \   00000B   EA           MOV     A,R2
   \   00000C   24FF         ADD     A,#-0x1
   \   00000E   FE           MOV     R6,A
   \   00000F   EB           MOV     A,R3
   \   000010   34FF         ADDC    A,#-0x1
   \   000012   FF           MOV     R7,A
    304          
    305            /* Insert SOP */
    306            msgPtr[0] = MT_UART_SOF;
   \   000013   8E82         MOV     DPL,R6
   \   000015   8F83         MOV     DPH,R7
   \   000017   74FE         MOV     A,#-0x2
   \   000019   F0           MOVX    @DPTR,A
    307          
    308            /* Insert FCS */
    309            msgPtr[SPI_0DATA_MSG_LEN - 1 + dataLen] = MT_UartCalcFCS (pBuf, (3 + dataLen));
   \   00001A   8982         MOV     DPL,R1
   \   00001C   8582..       MOV     ?V0 + 0,DPL
   \   00001F                ; Setup parameters for call to function MT_UartCalcFCS
   \   00001F   09           INC     R1
   \   000020   09           INC     R1
   \   000021   09           INC     R1
   \   000022   12....       LCALL   ??MT_UartCalcFCS?relay
   \   000025   EE           MOV     A,R6
   \   000026   25..         ADD     A,?V0 + 0
   \   000028   F582         MOV     DPL,A
   \   00002A   EF           MOV     A,R7
   \   00002B   3400         ADDC    A,#0x0
   \   00002D   F583         MOV     DPH,A
   \   00002F   A3           INC     DPTR
   \   000030   A3           INC     DPTR
   \   000031   A3           INC     DPTR
   \   000032   A3           INC     DPTR
   \   000033   E9           MOV     A,R1
   \   000034   F0           MOVX    @DPTR,A
    310          
    311            /* Send to UART */
    312          #ifdef MT_UART_DEFAULT_PORT
    313            //HalUARTWrite(MT_UART_DEFAULT_PORT, msgPtr, dataLen + SPI_0DATA_MSG_LEN);
    314            dbgsend(( msgPtr, dataLen + SPI_0DATA_MSG_LEN));
   \   000035                ; Setup parameters for call to function UartSend
   \   000035   E5..         MOV     A,?V0 + 0
   \   000037   2405         ADD     A,#0x5
   \   000039   FC           MOV     R4,A
   \   00003A   E4           CLR     A
   \   00003B   3400         ADDC    A,#0x0
   \   00003D   FD           MOV     R5,A
   \   00003E   EE           MOV     A,R6
   \   00003F   FA           MOV     R2,A
   \   000040   EF           MOV     A,R7
   \   000041   FB           MOV     R3,A
   \   000042   12....       LCALL   ??UartSend?relay
    315          #endif
    316          
    317            /* Deallocate */
    318            osal_msg_deallocate(msgPtr);
   \   000045                ; Setup parameters for call to function osal_msg_deallocate
   \   000045   EE           MOV     A,R6
   \   000046   FA           MOV     R2,A
   \   000047   EF           MOV     A,R7
   \   000048   FB           MOV     R3,A
   \   000049   12....       LCALL   ??osal_msg_deallocate?relay
    319          }
   \   00004C   80..         SJMP    ?Subroutine0

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TaskInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TaskInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportAlloc?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportAlloc

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportSend?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportSend
    320          #endif /* MT_TASK */
    321          /***************************************************************************************************
    322           ***************************************************************************************************/

   Maximum stack usage in bytes:

     Function                    ISTACK PSTACK XSTACK
     --------                    ------ ------ ------
     MT_ProcessEvent                 1      0     16
       -> osal_msg_receive           0      0     32
       -> MTProcessAppRspMsg         0      0     32
       -> MT_ProcessDebugStr         0      0     32
       -> MT_UartCalcFCS             0      0     32
       -> UartSend                   0      0     32
       -> MT_ProcessDebugMsg         0      0     32
       -> MT_ProcessIncoming         0      0     32
       -> osal_msg_deallocate        0      0     32
       -> MT_Init                    0      0     32
       -> MT_AfExec                  0      0     32
       -> MT_SysOsalTimerExpired     0      0     32
       -> MT_SysOsalTimerExpired     0      0     32
       -> MT_SysOsalTimerExpired     0      0     32
       -> MT_SysOsalTimerExpired     0      0     32
     MT_TaskInit                     0      0      9
       -> MT_UartInit                0      0     18
       -> MT_UartRegisterTaskID      0      0     18
       -> osal_set_event             0      0     18
     MT_TransportAlloc               0      0     10
       -> osal_msg_allocate          0      0     20
     MT_TransportSend                1      0     10
       -> MT_UartCalcFCS             0      0     20
       -> UartSend                   0      0     20
       -> osal_msg_deallocate        0      0     20


   Segment part sizes:

     Function/Label            Bytes
     --------------            -----
     MT_TaskID                    1
     MT_TaskInit                 33
     MT_ProcessEvent            308
     MT_TransportAlloc           37
     ?Subroutine0                 5
     MT_TransportSend            78
     ??MT_TaskInit?relay          6
     ??MT_ProcessEvent?relay      6
     ??MT_TransportAlloc?relay    6
     ??MT_TransportSend?relay     6

 
 461 bytes in segment BANKED_CODE
  24 bytes in segment BANK_RELAYS
   1 byte  in segment XDATA_Z
 
 485 bytes of CODE  memory
   1 byte  of XDATA memory

Errors: none
Warnings: none
